<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Configuration" href="config.html" /><link rel="prev" title="Tasks" href="tasks.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2022.12.07 -->
        <title>Executors - redun</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=91d0f0d1c444bdcb17a68e833c7a53903343c195" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">redun</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">redun</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="design.html">Design overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">Tasks</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Executors</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="db.html">Database repo</a></li>
<li class="toctree-l1"><a class="reference internal" href="spark.html">Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="typing.html">Type checking</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Developer guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="redun/modules.html">API docs</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="redun/redun.html">redun package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="redun/redun.backends.html">redun.backends package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="redun/redun.backends.db.html">redun.backends.db package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="redun/redun.executors.html">redun.executors package</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/insitro/redun">GitHub repository</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="section" id="executors">
<h1>Executors<a class="headerlink" href="#executors" title="Permalink to this heading">#</a></h1>
<p>redun is able to perform task execution across various compute infrastructure using modules called Executors. For example, redun supports executors that execute jobs on threads, processes, and AWS Batch jobs. New kinds of infrastructure can be utilized by registering additional Executor modules.</p>
<p>Executors are instantiated by sections in the <a class="reference internal" href="config.html"><span class="doc std std-doc">redun configuration</span></a> (<code class="docutils literal notranslate"><span class="pre">.redun/redun.ini</span></code>) following the format <code class="docutils literal notranslate"><span class="pre">[executors.{executor_name}]</span></code>, where <code class="docutils literal notranslate"><span class="pre">{executor_name}</span></code> is a user-specific name for the executor, such as <code class="docutils literal notranslate"><span class="pre">default</span></code>, <code class="docutils literal notranslate"><span class="pre">batch</span></code>, or <code class="docutils literal notranslate"><span class="pre">my_executor</span></code>. These names can then be referenced in workflows using the <code class="docutils literal notranslate"><span class="pre">executor</span></code> task option to indicate on which executor the task should execute:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">executor</span><span class="o">=</span><span class="s2">&quot;my_executor&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">task1</span><span class="p">():</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>By default, tasks execute on the <code class="docutils literal notranslate"><span class="pre">default</span></code> executor, which is a <a class="reference internal" href="#local-executor"><span class="std std-doc">Local executor</span></a> that executes tasks on multiple threads (or processes, if configured).</p>
<p>In terms of executors, there is no restriction on which tasks can call which other tasks. For example, an AWS Batch task can seemingly “call” a local task, even though AWS Batch jobs don’t have access to the local machine. This is possible because all task calls are lazy and are performed by the scheduler after the calling task completes.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">executor</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">task_on_batch</span><span class="p">():</span>
    <span class="c1"># This code runs on AWS Batch.</span>
    <span class="k">return</span> <span class="n">task_on_default</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># This appears to be a call back to a local task.</span>

<span class="nd">@task</span><span class="p">()</span>  <span class="c1"># option `executor` has default value &quot;default&quot;</span>
<span class="k">def</span> <span class="nf">task_on_default</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="c1"># This code runs on the local machine.</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Some executor options can be overridden per task using task options. For example, a user can specify a specific memory requirement (e.g. 10Gb) for a task using the <code class="docutils literal notranslate"><span class="pre">memory</span></code> task option:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">executor</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">task2</span><span class="p">():</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>Options can also be dynamic and overridden at call-time using the <code class="docutils literal notranslate"><span class="pre">Task.options</span></code> method:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">gigs_per_row</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">task_on_batch</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<div class="section" id="local-executor">
<h2>Local executor<a class="headerlink" href="#local-executor" title="Permalink to this heading">#</a></h2>
<p>The <strong>Local executor</strong> executes tasks on the same machine as the scheduler using either multiple threads or processes (configured by the <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">mode</span></code> option</span>). By default, redun defines a Local executor named “default” that is used as the default executor for tasks. Users can configure the local executor using the <a class="reference internal" href="config.html#local-executor"><span class="std std-doc">configuration file</span></a>.</p>
</div>
<div class="section" id="alias-executor">
<h2>Alias executor<a class="headerlink" href="#alias-executor" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">AliasExecutor</span></code> is a lazily-resolved alias for another executor, which allows
executors with distinct names to resolve to the same underlying implementation.</p>
<p>For example, consider these tasks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="nd">@task</span><span class="p">(</span><span class="n">executor</span><span class="o">=</span><span class="s2">&quot;foo_exec&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Hello world&#39;</span>


<span class="nd">@task</span><span class="p">(</span><span class="n">executor</span><span class="o">=</span><span class="s2">&quot;bar_exec&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">input</span><span class="s1">&#39;</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">greet</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Hello&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">())</span>
</pre></div>
</div>
<p>This example defined distinct executors for several tasks, perhaps because they need
different environments. However, sometimes we may need them to share underlying
executors, for example, to share resources. Without aliases, consider a configuration
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">executors</span><span class="o">.</span><span class="n">default</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">local</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">process</span>
<span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>

<span class="p">[</span><span class="n">executors</span><span class="o">.</span><span class="n">foo_exec</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">local</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">process</span>
<span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>

<span class="p">[</span><span class="n">executors</span><span class="o">.</span><span class="n">bar_exec</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">local</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">process</span>
<span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Although it appears this would only use one worker at a time, it is actually creating
three distinct process pools, each with one worker, and the executors are allowed to
operate in parallel to one another.</p>
<p>Using aliases, we can solve this problem. This configuration file explicitly configures
the automatically-created <code class="docutils literal notranslate"><span class="pre">process</span></code> executor, and ensures that every task will use it.
Since there is only one underlying process pool, with only a single worker, this achieves
the effect of running one task at a time. Note that <code class="docutils literal notranslate"><span class="pre">process</span></code> is overloaded; it is both the
name of the <code class="docutils literal notranslate"><span class="pre">mode</span></code> for the local executor, and also the name of one of the built-in executors.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">;</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">single</span><span class="o">-</span><span class="n">worker</span> <span class="n">executor</span> <span class="ow">in</span> <span class="n">process</span> <span class="n">mode</span> <span class="p">(</span><span class="n">instead</span> <span class="n">of</span> <span class="n">thread</span><span class="p">)</span>
<span class="p">[</span><span class="n">executors</span><span class="o">.</span><span class="n">single_worker</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">local</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">process</span>
<span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>

<span class="p">;</span> <span class="n">Redirect</span> <span class="n">both</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">executors</span> <span class="n">to</span> <span class="n">use</span> <span class="n">it</span>
<span class="p">[</span><span class="n">executors</span><span class="o">.</span><span class="n">process</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">alias</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">single_worker</span>

<span class="p">[</span><span class="n">executors</span><span class="o">.</span><span class="n">default</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">alias</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">single_worker</span>

<span class="p">;</span> <span class="n">And</span> <span class="n">redirect</span> <span class="n">both</span> <span class="n">task</span><span class="o">-</span><span class="n">specific</span> <span class="n">executors</span> <span class="n">to</span> <span class="n">use</span> <span class="n">it</span>
<span class="p">[</span><span class="n">executors</span><span class="o">.</span><span class="n">foo_exec</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">alias</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">single_worker</span>

<span class="p">[</span><span class="n">executors</span><span class="o">.</span><span class="n">bar_exec</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">alias</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">single_worker</span>
</pre></div>
</div>
</div>
<div class="section" id="aws-batch-executor">
<h2>AWS Batch executor<a class="headerlink" href="#aws-batch-executor" title="Permalink to this heading">#</a></h2>
<p>The <strong>AWS Batch executor</strong> executes tasks as jobs on <a class="reference external" href="https://aws.amazon.com/batch/">AWS Batch</a>, which is an AWS service for running <a class="reference external" href="https://www.docker.com/">Docker-based</a> jobs on a compute cluster. AWS Batch manages job queues, compute nodes, and job assignments such that compute requirements are met (e.g. memory, vcpus, etc). redun manages the task dependency graph and will only submit a task to execute on AWS Batch once all upstream tasks are complete.</p>
<div class="section" id="docker-image">
<h3>Docker image<a class="headerlink" href="#docker-image" title="Permalink to this heading">#</a></h3>
<p>To use AWS Batch, users must define a Docker image that contains the necessary code for their task. If a task is a pure <a class="reference internal" href="design.html#shell-scripting"><span class="std std-doc">script task</span></a>, only the commands used in the script need to be installed in the Docker image. However, if a regular task is to run on AWS Batch, then the <code class="docutils literal notranslate"><span class="pre">redun</span></code> python package must be installed in the Docker image to facilitate the execution of the task on the AWS Batch compute node. Typically, the workflow python code itself does not need to be installed inside the Docker image. Instead, redun provides automatic <a class="reference internal" href="#code-packaging"><span class="std std-doc">code packaging</span></a> as a convenience for quick iterative development.</p>
</div>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">#</a></h3>
<p>To use AWS Batch, at a minimum three options must be <a class="reference internal" href="config.html#aws-batch-executor"><span class="std std-doc">configured</span></a>, a Docker image for the job (<span class="xref myst"><code class="docutils literal notranslate"><span class="pre">image</span></code></span>), a AWS Batch queue to submit to (<span class="xref myst"><code class="docutils literal notranslate"><span class="pre">queue</span></code></span>), and a S3 path to store temporary files for communication between the scheduler and jobs (<span class="xref myst"><code class="docutils literal notranslate"><span class="pre">s3_scratch</span></code></span>).</p>
</div>
<div class="section" id="s3-scratch-space">
<h3>S3 scratch space<a class="headerlink" href="#s3-scratch-space" title="Permalink to this heading">#</a></h3>
<p>redun performs simple communication with AWS Batch jobs through a user defined S3 scratch space. Specifically, the arguments to a task are serialized as a python pickle and stored at a path such as <code class="docutils literal notranslate"><span class="pre">s3://{s3_scratch}/{eval_hash}/input</span></code>, where <code class="docutils literal notranslate"><span class="pre">eval_hash</span></code> is the hash of a task’s hash and its arguments and <code class="docutils literal notranslate"><span class="pre">s3_scratch</span></code> is defined in the <span class="xref myst">configuration</span>. When a task completes, its output is stored similarly in a pickle file <code class="docutils literal notranslate"><span class="pre">s3://{s3_scratch}/{eval_hash}/output</span></code>. Standard output and standard error is also captured in log files within the scratch space. All of these files are temporary and can be deleted by users once a workflow is complete.</p>
</div>
<div class="section" id="code-packaging">
<h3>Code packaging<a class="headerlink" href="#code-packaging" title="Permalink to this heading">#</a></h3>
<p>When running regular (non-script) tasks on AWS Batch, redun needs access to the workflow python code itself within the Docker container at runtime. While one could install the workflow python code in the Docker image, rebuilding and pushing Docker images for each code change could be burdensome during quick iterative development. As a convenience, redun provides a mechanism, called code packaging, for copying code into the Docker container at runtime.</p>
<p>By default, redun copies all files matching the pattern <code class="docutils literal notranslate"><span class="pre">**/*.py</span></code> into a tar file that is copied to the s3 scratch space. This tar file is then downloaded and unzipped within the running Docker container prior to executing the task. The specific files included in the code package can be controlled using <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">code_includes</span></code> and <code class="docutils literal notranslate"><span class="pre">code_excludes</span></code> configuration options</span>.</p>
</div>
<div class="section" id="job-reuniting">
<h3>Job reuniting<a class="headerlink" href="#job-reuniting" title="Permalink to this heading">#</a></h3>
<p>In certain situations, such as errors or user initiated killing, the redun scheduler might be terminated while AWS Batch jobs are running. If the redun scheduler is restarted, it will attempt to determine if a batch task has an existing AWS Batch job already running or if one has recently completed leaving an output file in s3 scratch space. If so, the redun scheduler will “reunite” with such jobs and output and avoid double submission of AWS Batch jobs. redun uses the <code class="docutils literal notranslate"><span class="pre">eval_hash</span></code> to ensure the task hash and arguments are the same since the previous job submission.</p>
</div>
<div class="section" id="local-debugging">
<h3>Local debugging<a class="headerlink" href="#local-debugging" title="Permalink to this heading">#</a></h3>
<p>During development, it may be easier to run the Docker image locally in order to debug and interactively inspect a job. Local execution of Docker-base jobs can be achieved by using the <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">debug=True</span></code> option</span>. The S3 scratch space will still be used to transfer input and output with the Docker container.</p>
<p>The docker container will run in interactive mode (e.g. <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--interactive</span> <span class="pre">...</span></code>), allowing users to place debugging breakpoints within tasks or see task output on stdout. The task option <code class="docutils literal notranslate"><span class="pre">interactive=False</span></code> can also be used to run the Docker container without interactive mode.</p>
<p>The task option <code class="docutils literal notranslate"><span class="pre">volume</span></code> can also be used to define volume mounts for the Docker container during debugging. Format is <code class="docutils literal notranslate"><span class="pre">volume</span> <span class="pre">=</span> <span class="pre">[(host,</span> <span class="pre">container),</span> <span class="pre">...]</span></code>, where <code class="docutils literal notranslate"><span class="pre">host</span></code> defines a source path on the host machine, and <code class="docutils literal notranslate"><span class="pre">container</span></code> defines a destination path within the container to perform the mount.</p>
</div>
<div class="section" id="multi-node">
<h3>Multi-node<a class="headerlink" href="#multi-node" title="Permalink to this heading">#</a></h3>
<p>AWS Batch allows for jobs that simultaneously use multiple compute nodes. See AWS <a class="reference external" href="https://docs.aws.amazon.com/batch/latest/userguide/multi-node-parallel-jobs.html">documentation</a></p>
<p>If the executor is configured to use multiple nodes, by setting <code class="docutils literal notranslate"><span class="pre">num_nodes</span></code>, the executor will invoke the task with identical arguments on each node. Batch starts the main node first, then starts the rest of the nodes. The task implementation may inspect the AWS environment variables for details on the multi-node configuration, such as detecting if it is the main node, or determining the IPs to construct a peer network.</p>
<p>Warning: For python tasks, the executor will instruct only the main node to write its outputs to storage and non-main node outputs are discarded. For script tasks, the various nodes must somehow arrange that the output is only written once, but the infrastructure does not help.</p>
<p>Multi-node jobs are currently incompatible with array jobs, because this appears not to be supported by AWS.</p>
</div>
</div>
<div class="section" id="docker-executor">
<h2>Docker executor<a class="headerlink" href="#docker-executor" title="Permalink to this heading">#</a></h2>
<p>The Docker executor (<code class="docutils literal notranslate"><span class="pre">type=docker</span></code>) runs each redun job inside a local Docker container. This executor is used by AWS Batch Executor when using debug mode.</p>
</div>
<div class="section" id="aws-glue-spark-executor">
<h2>AWS Glue Spark executor<a class="headerlink" href="#aws-glue-spark-executor" title="Permalink to this heading">#</a></h2>
<p>The <strong>AWS Glue executor</strong> executes tasks as jobs on <a class="reference external" href="https://aws.amazon.com/glue/">AWS Glue</a>, which runs <a class="reference external" href="https://spark.apache.org/">Apache Spark</a> jobs on a managed cluster. Spark jobs run on many CPUs and are especially useful for working with large tabular datasets such as those represented in Pandas DataFrames.</p>
<p>Spark jobs are essentially a mini compute cluster, with a driver that maintains a SparkContext object, and a number of workers.
Each worker can have one or more <strong>executors</strong>, which are the processes that run individual tasks in the Spark job. They typically
run for the life of the application and send results to the driver when complete. Executors may use multiple vCPU cores to get
their work done, depending on the configuration.</p>
<p>To use AWS Glue, at a minimum you must configure a temporary location in S3 where files used to communicate between the scheduler and jobs are stored. Scratch space, code packaging, and job reuniting are all done in a similar way to the AWS Batch executor.</p>
<div class="section" id="loading-and-writing-datasets">
<h3>Loading and writing datasets<a class="headerlink" href="#loading-and-writing-datasets" title="Permalink to this heading">#</a></h3>
<p>Spark datasets are typically sharded across multiple files on disk. The <code class="docutils literal notranslate"><span class="pre">ShardedS3Dataset</span></code> class provides an interface to
these datasets that can be tracked and recorded by redun.</p>
<div class="highlight-eval_rst notranslate"><div class="highlight"><pre><span></span>.. autoclass:: redun.file.ShardedS3Dataset
   :members:
</pre></div>
</div>
</div>
<div class="section" id="helper-functions">
<h3>Helper functions<a class="headerlink" href="#helper-functions" title="Permalink to this heading">#</a></h3>
<p>Spark jobs are written a bit differently than pure Python. You’ll want to load large datasets to Spark DataFrames with <code class="docutils literal notranslate"><span class="pre">ShardedS3Dataset</span></code>, but frequently other operations will require the use of the Spark context that is defined when the
job is running.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">redun.glue</span></code> module provides helper functions that can be used in glue executor jobs and can be imported into the
top level of your redun script, even when Spark isn’t yet defined. The <code class="docutils literal notranslate"><span class="pre">redun.glue.get_spark_context()</span></code> and
<code class="docutils literal notranslate"><span class="pre">redun.glue.get_spark_session()</span></code> functions can be used in your tasks to retrieve the currently defined spark environment.</p>
<div class="section" id="user-defined-functions">
<h4>User-defined functions<a class="headerlink" href="#user-defined-functions" title="Permalink to this heading">#</a></h4>
<p>You might want to define your own functions to operate on a dataset. Typically, you’d use the <code class="docutils literal notranslate"><span class="pre">pyspark.sql.functions.udf</span></code> decorator
on a function to make it a UDF, but when redun evaluates the decorator it will error out as there is no spark context available
to register the function to. The <code class="docutils literal notranslate"><span class="pre">redun.glue.udf</span></code> decorator handles this issue. See the redun examples for real-world use
of UDFs and this decorator.</p>
</div>
</div>
<div class="section" id="available-python-modules">
<h3>Available Python modules<a class="headerlink" href="#available-python-modules" title="Permalink to this heading">#</a></h3>
<p>AWS Glue automates management, provisioning, and deployment of Spark clusters, but only with a <a class="reference external" href="https://docs.aws.amazon.com/glue/latest/dg/aws-glue-programming-python-libraries.html#glue20-modules-provided">pre-determined set of Python modules</a>.
Most functionality you may need is already available, including scipy, pandas, etc.</p>
<p>Additional modules that are available in the public PyPi repository can be installed with the <code class="docutils literal notranslate"><span class="pre">additional_libs</span></code> task option.
However, other modules, especially those using C/C++ compiled extensions, are not really installable at this time.</p>
</div>
<div class="section" id="task-options">
<h3>Task options<a class="headerlink" href="#task-options" title="Permalink to this heading">#</a></h3>
<p>The following configuration options may be specified on a per-task basis in the decorator.</p>
<div class="section" id="workers">
<h4><code class="docutils literal notranslate"><span class="pre">workers</span></code><a class="headerlink" href="#workers" title="Permalink to this heading">#</a></h4>
<p>An integer that specifies the number of workers available by default to Glue jobs. Each worker provides one or more “data processing units” (DPUs). AWS defines a  DPU as “a relative measure of processing power that consists of 4 vCPUs of compute capacity and 16GB of memory.” Depending on the worker type, there will be one or more Spark executors per DPU, each with one or more spark cores. Jobs are billed by number of DPUs and time.</p>
</div>
<div class="section" id="worker-type">
<h4><code class="docutils literal notranslate"><span class="pre">worker_type</span></code><a class="headerlink" href="#worker-type" title="Permalink to this heading">#</a></h4>
<p>Choose from:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Standard</span></code>: each worker will have a 50GB disk scratch space and 2 executors, each with 4 vCPU cores.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">G.1X</span></code>: each worker maps to 1 DPU and a single executor, with 8 vCPU cores and 10 GiB of memory. AWS recommends
this worker type for memory-intensive jobs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">G.2X</span></code>: each worker maps to 2 DPUs and a single executor, with 16 vCPU cores and 24576 MiB of memory. AWS recommends
this worker type for memory-intensive jobs or ML transforms. Note that as this worker type provides 2 DPUs, it is twice
as expensive as the others.</p></li>
</ul>
</div>
<div class="section" id="additional-libs">
<h4><code class="docutils literal notranslate"><span class="pre">additional_libs</span></code><a class="headerlink" href="#additional-libs" title="Permalink to this heading">#</a></h4>
<p>A list of additional Python libraries that will be <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code>’ed before the run starts. For example,
<code class="docutils literal notranslate"><span class="pre">additional_libs=[&quot;promise&quot;,</span> <span class="pre">&quot;alembic==1.0.0&quot;]</span></code> will install the promise and alembic libraries.</p>
</div>
<div class="section" id="extra-files">
<h4><code class="docutils literal notranslate"><span class="pre">extra_files</span></code><a class="headerlink" href="#extra-files" title="Permalink to this heading">#</a></h4>
<p>A list of files that will be made available in the root directory of the run.</p>
</div>
</div>
<div class="section" id="kubernetes-k8s-executor">
<h3>Kubernetes (k8s) executor<a class="headerlink" href="#kubernetes-k8s-executor" title="Permalink to this heading">#</a></h3>
<p>The <strong>k8s executor</strong> executes tasks as jobs on a <a class="reference external" href="https://kubernetes.io/">Kubernetes</a> cluster. This executors works similar to the <a class="reference internal" href="#aws-batch-executor"><span class="std std-doc">AWS Batch Executor</span></a> in terms of using scratch object storage to transfer task arguments, results, and code packaging. See the <a class="reference internal" href="config.html#kubernetes-k8s-executor"><span class="std std-doc">configuration documentation</span></a> for more details.</p>
<p>Note: The k8s executor is new executor provided as a beta release. If you experience an issues, please report them to help improve the implementation.</p>
</div>
</div>
</div>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="config.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Configuration</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="tasks.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Tasks</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2020, Matt Rasmussen
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Executors</a><ul>
<li><a class="reference internal" href="#local-executor">Local executor</a></li>
<li><a class="reference internal" href="#alias-executor">Alias executor</a></li>
<li><a class="reference internal" href="#aws-batch-executor">AWS Batch executor</a><ul>
<li><a class="reference internal" href="#docker-image">Docker image</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#s3-scratch-space">S3 scratch space</a></li>
<li><a class="reference internal" href="#code-packaging">Code packaging</a></li>
<li><a class="reference internal" href="#job-reuniting">Job reuniting</a></li>
<li><a class="reference internal" href="#local-debugging">Local debugging</a></li>
<li><a class="reference internal" href="#multi-node">Multi-node</a></li>
</ul>
</li>
<li><a class="reference internal" href="#docker-executor">Docker executor</a></li>
<li><a class="reference internal" href="#aws-glue-spark-executor">AWS Glue Spark executor</a><ul>
<li><a class="reference internal" href="#loading-and-writing-datasets">Loading and writing datasets</a></li>
<li><a class="reference internal" href="#helper-functions">Helper functions</a></li>
<li><a class="reference internal" href="#available-python-modules">Available Python modules</a></li>
<li><a class="reference internal" href="#task-options">Task options</a></li>
<li><a class="reference internal" href="#kubernetes-k8s-executor">Kubernetes (k8s) executor</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/furo.js"></script>
    </body>
</html>