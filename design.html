<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Tasks" href="tasks.html" /><link rel="prev" title="Install" href="index.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.03.04"/>
        <title>Design overview - redun</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=935aa2abcc5c1da4283d1dc201fb1f0add16d23a" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=25ceb02ed1c46dc30f2321ff83e92799f69dfdb9" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">redun</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">redun</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Design overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="executors.html">Executors</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="db.html">Database repo</a></li>
<li class="toctree-l1"><a class="reference internal" href="spark.html">Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="typing.html">Type checking</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Developer guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/insitro/redun">GitHub repository</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="design-overview">
<h1>Design overview<a class="headerlink" href="#design-overview" title="Permalink to this headline">#</a></h1>
<p>Here, we describe the high-level design features of redun.</p>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">#</a></h2>
<p>The goal of redun is to provide the benefits of workflow engines for Python code in an easy and unintrusive way. Workflow engines can help run code faster by using parallel distributed execution, they can provide checkpointing for fast resuming of previously halted execution, they can reactively re-execute code based on changes in data or code, and can provide logging for data provenance.</p>
<p>While there are <a class="reference external" href="https://github.com/pditommaso/awesome-pipeline">A LOT</a> of workflow engines available even for Python, redun differs by avoiding the need to restructure programs in terms of dataflow. In fact, we take the position that writing dataflows directly is unnecessarily restrictive, and by doing so we lose abstractions we have come to rely on in most modern high-level languages (control flow, recursion, higher order functions, etc). redun’s key insight is that workflows can be expressed as lazy expressions, that are then evaluated by a scheduler which performs automatic parallelization, caching, and data provenance logging.</p>
<p>redun’s key features are:</p>
<ul class="simple">
<li><p>Workflows are defined by lazy expressions that when evaluated emit dynamic directed acyclic graphs (DAGs), enabling complex data flows.</p></li>
<li><p>Incremental computation that is reactive to both data changes as well as code changes.</p></li>
<li><p>Workflow tasks can be executed on a variety of compute backend (threads, processes, AWS batch jobs, Spark jobs, etc).</p></li>
<li><p>Data changes are detected for in memory values as well as external data sources such as files and object stores using file hashing.</p></li>
<li><p>Code changes are detected by hashing individual Python functions and comparing against historical call graph recordings.</p></li>
<li><p>Past intermediate results are cached centrally and reused across workflows.</p></li>
<li><p>Past call graphs can be used as a data lineage record and can be queried for debugging and auditing.</p></li>
</ul>
<p>See the <a class="reference internal" href="#influences"><span class="std std-doc">influences</span></a> for more details on how these features relate to other tools.</p>
</section>
<section id="first-example">
<h2>First example<a class="headerlink" href="#first-example" title="Permalink to this headline">#</a></h2>
<p>redun augments Python to simulate a functional language with lazy evaluation. By writing code as pure functions without side-effects, redun can safely perform parallel execution and cache function results. By using <a class="reference internal" href="#lazy-evaluation-and-parallelism"><span class="std std-doc">lazy evaluation</span></a>, we can execute a Python program quickly to automatically discover the dataflow between functions. Therefore, it is unnecessary to force the developer to specify the dataflow directly (e.g. Airflow’s <code class="docutils literal notranslate"><span class="pre">set_upstream()</span></code> and <code class="docutils literal notranslate"><span class="pre">set_downstream()</span></code>).</p>
<p>redun does not try to impose a functional style on all code. Python supports multiple programming paradigms and a typical project might include libraries that makes use of all of them. Therefore, redun allows the user to annotate which functions are effectively pure using a <code class="docutils literal notranslate"><span class="pre">@task</span></code> decorator. Such functions are called Tasks and they are the main unit of execution in redun. Tasks have several special properties that make them a powerful building block for data pipelines.</p>
<p>Here, is a small hello world program for redun:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># hello_world.py</span>
<span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">Scheduler</span>

<span class="n">redun_namespace</span> <span class="o">=</span> <span class="s2">"hello_world"</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_planet</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"World"</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">greeter</span><span class="p">(</span><span class="n">greet</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">thing</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">greet</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">"Hello"</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">greeter</span><span class="p">(</span><span class="n">greet</span><span class="p">,</span> <span class="n">get_planet</span><span class="p">())</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>It could be executed as a regular Python script:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python hello_world.py
<span class="c1"># Which prints:</span>
Hello, World!
</pre></div>
</div>
<p>Or it can be executed with the <code class="docutils literal notranslate"><span class="pre">redun</span></code> command-line program:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>redun run hello_world.py main
<span class="c1"># Which prints:</span>
<span class="s1">'Hello, World!'</span>
</pre></div>
</div>
<p>There is nothing special about the <code class="docutils literal notranslate"><span class="pre">main()</span></code> task, we could call any task from the command line:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>redun run hello_world.py greeter --greet Hello --thing <span class="s2">"Mars"</span>
<span class="c1"># Which prints:</span>
<span class="s1">'Hello, Mars!'</span>
</pre></div>
</div>
</section>
<section id="key-features">
<h2>Key features<a class="headerlink" href="#key-features" title="Permalink to this headline">#</a></h2>
<section id="memoization-and-reactivity">
<h3>Memoization and reactivity<a class="headerlink" href="#memoization-and-reactivity" title="Permalink to this headline">#</a></h3>
<p>The return value of tasks are memoized. When calling the same task with the same arguments, a previously cached result is use instead of re-executing the task. This allows us to quickly resume a past execution, by fast forwarding through old parts of a program and only executing new parts.</p>
<p>Consider the example above, which is also available in <code class="docutils literal notranslate"><span class="pre">examples/hello_world.py</span></code>. On first execution, every task executes as indicated by the “[redun] Run” log lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">run</span> <span class="n">hello_world</span><span class="o">.</span><span class="n">py</span> <span class="n">main</span>

<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">main</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">8</span><span class="n">cc26021</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'greet'</span><span class="p">:</span> <span class="s1">'Hello'</span><span class="p">})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">get_planet</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">e9a65320</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">get_planet</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">greeter</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">6447887</span><span class="n">f</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">greeter</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'Hello'</span><span class="p">,</span> <span class="s1">'World'</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="s1">'Hello, World!'</span>
</pre></div>
</div>
<p>If we run a second time, all of the tasks will be cached (memoized) and will be fast-forwarded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">run</span> <span class="n">hello_world</span><span class="o">.</span><span class="n">py</span> <span class="n">main</span>

<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">main</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">8</span><span class="n">cc26021</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">get_planet</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">e9a65320</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">greeter</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">6447887</span><span class="n">f</span><span class="p">)</span><span class="o">...</span>
<span class="s1">'Hello, World!'</span>
</pre></div>
</div>
<p>However, if we run with a new input argument, redun will detect that some tasks (<code class="docutils literal notranslate"><span class="pre">main</span></code>, <code class="docutils literal notranslate"><span class="pre">greeter</span></code>) do need to be re-executed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">run</span> <span class="n">hello_world</span><span class="o">.</span><span class="n">py</span> <span class="n">main</span> <span class="o">--</span><span class="n">greet</span> <span class="n">Hi</span>

<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">main</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">ff5c0bea</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'greet'</span><span class="p">:</span> <span class="s1">'Hi'</span><span class="p">})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">get_planet</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">e9a65320</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">greeter</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">ce5daced</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">greeter</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'Hi'</span><span class="p">,</span> <span class="s1">'World'</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="s1">'Hi, World!'</span>
</pre></div>
</div>
<p>Also, notice that <code class="docutils literal notranslate"><span class="pre">get_planet()</span></code> did not need to be run again, because it arguments <code class="docutils literal notranslate"><span class="pre">()</span></code> are unchanged.</p>
<p>redun not only reacts to new input data changes, but it can also react to new <em>code changes</em>. Say we updated <code class="docutils literal notranslate"><span class="pre">get_planet()</span></code> to</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_planet</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'Venus'</span>
</pre></div>
</div>
<p>If we run redun again, redun will detect that <code class="docutils literal notranslate"><span class="pre">get_planet()</span></code> needs to run again because it’s code has changed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">run</span> <span class="n">hello_world</span><span class="o">.</span><span class="n">py</span> <span class="n">main</span>

<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">main</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">8</span><span class="n">cc26021</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">get_planet</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">f01c0932</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">get_planet</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">greeter</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mf">0e90</span><span class="n">d651</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">greeter</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'Hello'</span><span class="p">,</span> <span class="s1">'Venus'</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="s1">'Hello, Venus!'</span>
</pre></div>
</div>
<p>How is this achieved? To make this memoization work, we need to know whether we have seen the same Task called with the same arguments. redun performs <a class="reference internal" href="#task-hashing"><span class="std std-doc">hashing of Tasks</span></a> (see below) and arguments, and uses those hashes as a cache key for fetching values from a result cache.</p>
</section>
<section id="lazy-evaluation-and-parallelism">
<h3>Lazy evaluation and parallelism<a class="headerlink" href="#lazy-evaluation-and-parallelism" title="Permalink to this headline">#</a></h3>
<p>Tasks are executed in a lazy and asynchronous manner. When a task is called, it returns immediately with an <code class="docutils literal notranslate"><span class="pre">Expression</span></code> object:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">task1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="nb">print</span><span class="p">(</span><span class="n">task1</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="c1"># TaskExpression('task1', (10,), {'y': 3})</span>
</pre></div>
</div>
<p>This expression means, “apply Task ‘task1’ to arguments <code class="docutils literal notranslate"><span class="pre">10</span></code> and <code class="docutils literal notranslate"><span class="pre">y=3</span></code>”. Expressions are evaluated to their concrete values by the redun scheduler:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">Scheduler</span>

<span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scheduler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task1</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">)))</span>
<span class="c1"># 13</span>
</pre></div>
</div>
<p>To build up a larger program, these Expression objects can be used as arguments to other Tasks, such as:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">task1</span><span class="p">(</span><span class="n">task1</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">)))</span>
<span class="c1"># TaskExpression('task1', (TaskExpression('task1', (10,), {'y': 3}),), {})</span>
</pre></div>
</div>
<p>This gives us a tree of expressions, and more generally they can be Directed Acyclic Graphs (DAGs).</p>
<p>The redun scheduler analyzes these expression DAGs in order to determine in which order tasks need to be executed and which are safe to execute in parallel. For example, take the following program:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assume step1, step2a, step2b are Tasks.</span>
<span class="c1"># Assume data is already defined.</span>

<span class="n">result1</span> <span class="o">=</span> <span class="n">step1</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">result2a</span> <span class="o">=</span> <span class="n">step2a</span><span class="p">(</span><span class="n">result1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">)</span>
<span class="n">result2b</span> <span class="o">=</span> <span class="n">step2b</span><span class="p">(</span><span class="n">result1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">result3</span> <span class="o">=</span> <span class="n">step3</span><span class="p">(</span><span class="n">result2a</span><span class="p">,</span> <span class="n">result2b</span><span class="p">)</span>
</pre></div>
</div>
<p>redun would execute all four lines immediately, deferring executing the steps themselves, and builds up the following DAG of Tasks and Expressions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">--&gt;</span> <span class="n">step1</span> <span class="o">--&gt;</span> <span class="n">result1</span> <span class="o">--&gt;</span> <span class="n">step2a</span> <span class="o">--&gt;</span> <span class="n">result2a</span> <span class="o">---&gt;</span> <span class="n">step3</span> <span class="o">--</span> <span class="n">result3</span>
                         \                          <span class="o">/</span>
                          \<span class="o">--&gt;</span> <span class="n">step2b</span> <span class="o">--&gt;</span> <span class="n">result2b</span> <span class="o">/</span>
</pre></div>
</div>
<p>redun will notice that <code class="docutils literal notranslate"><span class="pre">step2a</span></code> and <code class="docutils literal notranslate"><span class="pre">step2b</span></code> are safe to execute in parallel in separate threads (or processes, or batch jobs, etc).</p>
<p>Every argument of a task can be a concrete value (e.g. <code class="docutils literal notranslate"><span class="pre">10</span></code>, <code class="docutils literal notranslate"><span class="pre">'red'</span></code>, <code class="docutils literal notranslate"><span class="pre">True</span></code>, a DataFrame, etc) or a lazy Expression of a value (e.g. <code class="docutils literal notranslate"><span class="pre">result1</span></code>). Just before a task executes, any arguments that were Expressions are resolved and replaced with concrete values. A task can also return an Expression received from subtasks as if it were a concrete value.</p>
<p>Working with lazy expressions requires some changes to how programs are structured. Briefly, once you have an Expression, the only way to “look inside” it, is to pass it to another task.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">adder</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="c1"># Arguments, such as `values` here, are always guaranteed to be concrete values.</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">step1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">step1</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">step1</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="c1"># `results` is now a list of Expressions.</span>
    <span class="c1"># To add them together we need to pass them to another task.</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">adder</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
<p>For those who are familiar with <a class="reference external" href="https://en.wikipedia.org/wiki/Futures_and_promises">Promises</a> from other languages such as javascript, redun tasks perform the equivalent Promise manipulations:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// This call</span>
<span class="nx">result2a</span> <span class="o">=</span> <span class="nx">step2a</span><span class="p">(</span><span class="nx">result1</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">)</span>
<span class="c1">// is equivalent to</span>
<span class="nx">result2a</span> <span class="o">=</span> <span class="nx">result1</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result1</span> <span class="p">=&gt;</span> <span class="nx">step2a</span><span class="p">(</span><span class="nx">result1</span><span class="p">,</span> <span class="mf">10</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// This call</span>
<span class="nx">result3</span> <span class="o">=</span> <span class="nx">step3</span><span class="p">(</span><span class="nx">result2a</span><span class="p">,</span> <span class="nx">result2b</span><span class="p">)</span>
<span class="c1">// is equivalent to</span>
<span class="nx">result3</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">result2a</span><span class="p">,</span> <span class="nx">result2b</span><span class="p">]).</span><span class="nx">then</span><span class="p">(([</span><span class="nx">result2a</span><span class="p">,</span> <span class="nx">result2b</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="nx">step3</span><span class="p">(</span><span class="nx">result2a</span><span class="p">,</span> <span class="nx">result2b</span><span class="p">))</span>
</pre></div>
</div>
<p>Our use of Expressions to build up Task dependency is also similar to <a class="reference external" href="https://docs.python.org/dev/library/concurrent.futures.html">Concurrent Futures in Python</a> and <a class="reference external" href="https://docs.dask.org/en/latest/delayed.html">Dask Delayed</a>.</p>
</section>
<section id="tasks-as-pure-functions">
<h3>Tasks as pure functions<a class="headerlink" href="#tasks-as-pure-functions" title="Permalink to this headline">#</a></h3>
<p>In order for redun to safely cache result and execute tasks in parallel, a few restrictions must be followed when writing a task. Primarily, tasks must be written such that they are “effectively <a class="reference external" href="https://en.wikipedia.org/wiki/Pure_function">pure functions</a>”. That is, given the same arguments, a task should always return (effectively) the same result. redun does not try to enforce strict purity, so minor side-effects such logging, or caching, are not an issue. A task can even be stochastic as long as the user is ok with using cached results from previous executions.</p>
<p>Tasks are allowed to call other tasks, just like one would write a function to call other functions. In fact, this is the encouraged way of building up a workflow program. Tasks are also allowed to call plain Python functions, as long as the net result of the task is effectively pure. You may also call tasks from plain Python functions as well. In fact, this often occurs when using functions such as <code class="docutils literal notranslate"><span class="pre">map()</span></code>.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">small_helper</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="c1"># Small plain Python code...</span>
    <span class="k">return</span> <span class="n">item2</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="c1"># Process an item...</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">small_helper</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_items</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">process_item</span><span class="p">,</span> <span class="n">items</span><span class="p">))</span>
</pre></div>
</div>
<p>One point of caution about using plain Python functions is that redun cannot hash the contents of a plain Python function, such as <code class="docutils literal notranslate"><span class="pre">small_helper</span></code> above. So changes to that function will not trigger re-execution. It becomes the responsibility of the user to force re-execution if needed, perhaps by bumping the version of the calling task (<code class="docutils literal notranslate"><span class="pre">process_item</span></code>, see <a class="reference internal" href="#task-hashing"><span class="std std-doc">Task Hashing</span></a>).</p>
</section>
<section id="task-hashing">
<h3>Task hashing<a class="headerlink" href="#task-hashing" title="Permalink to this headline">#</a></h3>
<p>In order to correctly cache and reuse past Task results, we need to follow the following rule:</p>
<blockquote>
<div><p>We can use a cached value instead of re-executing a task, if that result was previously returned from the same task called with the same arguments.</p>
</div></blockquote>
<p>To detect whether we’ve seen the same function or arguments, we use hashing. First, arguments are hashed by pickling and performing a sha512 hash of the bytes (the serialization and hashing can be overwritten by the user if needed).</p>
<p>For Tasks, redun provides multiple ways to determine a hash. By default, Tasks are hashed by their name, namespace, and source code. You can inspect this process yourself with <code class="docutils literal notranslate"><span class="pre">Task.source</span></code> and <code class="docutils literal notranslate"><span class="pre">Task.hash</span></code> attributes:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="nb">print</span><span class="p">(</span><span class="n">step1</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
<span class="c1"># """def step1(a, b):</span>
<span class="c1">#     return a + b</span>
<span class="c1"># """</span>

<span class="nb">print</span><span class="p">(</span><span class="n">step1</span><span class="o">.</span><span class="n">hash</span><span class="p">)</span>
<span class="c1"># '3f50b2a534c0bf3f1a977afbe1d89ba04501a6f0'</span>
</pre></div>
</div>
<p>Hashing based on the source of a Task function is very convenient for iterative development. Simply by changing the code of a Task, redun will detect that it will need to re-execute it.</p>
<p>Sometimes, a user may want to refactor a Task without triggering re-execution. This can be done by manually versioning tasks, and only bumping the version when a meaningful change is made to the Task. Any string can be used as a task version. No ordering is assumed with versions, redun only checks task version equality.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
</section>
<section id="task-naming">
<h3>Task naming<a class="headerlink" href="#task-naming" title="Permalink to this headline">#</a></h3>
<p>Every task has a name and namespace that uniquely identifies it within and across workflows. Task names and namespaces are also used as part of <a class="reference internal" href="#task-hashing"><span class="std std-doc">task hashing</span></a> to ensure unique hashes. Typically, the name of a task can be automatically inferred from the function’s name (e.g. <code class="docutils literal notranslate"><span class="pre">func.__name__</span></code>) and the namespace can be set once at the top of a module (<code class="docutils literal notranslate"><span class="pre">redun_namespace</span></code>). For example, in this workflow</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># workflow.py</span>
<span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span>

<span class="n">redun_namespace</span> <span class="o">=</span> <span class="s2">"my_workflow"</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_task</span><span class="p">():</span>
    <span class="c1"># ... task definition</span>
</pre></div>
</div>
<p>the task <code class="docutils literal notranslate"><span class="pre">my_task()</span></code> has name <code class="docutils literal notranslate"><span class="pre">my_task</span></code> and namespace <code class="docutils literal notranslate"><span class="pre">my_workflow</span></code>. From the command line, you can run <code class="docutils literal notranslate"><span class="pre">my_task</span></code> as</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>redun run workflow.py my_task
</pre></div>
</div>
<p>or with its fully qualified name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>redun run workflow.py my_workflow.my_task
</pre></div>
</div>
<p>If needed, task name and workflow can be defined directly in the <code class="docutils literal notranslate"><span class="pre">@task</span></code> decorator:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"cool_task"</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">"acme"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_task</span><span class="p">():</span>
    <span class="c1"># ... task definition</span>
</pre></div>
</div>
<p>Namespaces are especially important for distinguishing tasks when call graphs recorded from different workflows are combined into one database.</p>
</section>
<section id="result-caching">
<h3>Result caching<a class="headerlink" href="#result-caching" title="Permalink to this headline">#</a></h3>
<p>Fully satisfying the caching rule is actually harder than it first looks. First consider this example:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">step2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>

<span class="nd">@task</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">result1</span> <span class="o">=</span> <span class="n">step1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">step2</span><span class="p">(</span><span class="n">result1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result2</span>
</pre></div>
</div>
<p>When we execute <code class="docutils literal notranslate"><span class="pre">main(10)</span></code>, we get the result <code class="docutils literal notranslate"><span class="pre">(10</span> <span class="pre">+</span> <span class="pre">1)</span> <span class="pre">*</span> <span class="pre">2</span> <span class="pre">=</span> <span class="pre">22</span></code>.</p>
<p>Now, say we updated <code class="docutils literal notranslate"><span class="pre">step1</span></code> to be:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">'2'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span>
</pre></div>
</div>
<p>The correct answer to re-executing <code class="docutils literal notranslate"><span class="pre">main(10)</span></code> should be <code class="docutils literal notranslate"><span class="pre">((10</span> <span class="pre">+</span> <span class="pre">2)</span> <span class="pre">*</span> <span class="pre">2)</span> <span class="pre">=</span> <span class="pre">24</span></code>, however, overly simplistic result caching could miss the need to re-execute. After all, the code for <code class="docutils literal notranslate"><span class="pre">main</span></code> has not been changed (it’s still version=’1’) and neither have its arguments, <code class="docutils literal notranslate"><span class="pre">10</span></code>. In order to handle such cases correctly, redun takes the following approach.</p>
<p>On the first execution of <code class="docutils literal notranslate"><span class="pre">scheduler.run(main(10))</span></code>:</p>
<ul class="simple">
<li><p>The scheduler considers <code class="docutils literal notranslate"><span class="pre">main(10)</span></code> as an Expression <code class="docutils literal notranslate"><span class="pre">TaskExpression('main',</span> <span class="pre">(10,),</span> <span class="pre">{})</span></code>.</p></li>
<li><p>It first creates a cache key <code class="docutils literal notranslate"><span class="pre">(task=main,</span> <span class="pre">version='1',</span> <span class="pre">args=10)</span></code> and uses it to look up in a key-value store whether a previous result for this task call has been recorded. As this is our first execution, it will be a cache miss.</p></li>
<li><p>The function <code class="docutils literal notranslate"><span class="pre">main(10)</span></code> is executed, and its initial result is an Expression tree: <code class="docutils literal notranslate"><span class="pre">TaskExpression('step2',</span> <span class="pre">(TaskExpression('task1',</span> <span class="pre">(10,)</span> <span class="pre">{}),),</span> <span class="pre">{})</span></code>.</p></li>
<li><p>The <em>expression tree itself</em> is cached for the cache key <code class="docutils literal notranslate"><span class="pre">(task=main,</span> <span class="pre">version='1',</span> <span class="pre">args=10)</span></code>.</p></li>
<li><p>The redun scheduler proceeds to evaluate the Expression tree, calling task <code class="docutils literal notranslate"><span class="pre">task1(10)</span></code> and then <code class="docutils literal notranslate"><span class="pre">task2(11)</span></code>.</p></li>
<li><p>Each of their results are cached with cache keys indicating the task, task version/hash, and arguments.</p></li>
<li><p>Ultimately the scheduler returns concrete value <code class="docutils literal notranslate"><span class="pre">22</span></code>.</p></li>
</ul>
<p>For the second execution, with version=’2’ for step1, we have:</p>
<ul class="simple">
<li><p>The scheduler considers <code class="docutils literal notranslate"><span class="pre">main(10)</span></code> as an Expression <code class="docutils literal notranslate"><span class="pre">TaskExpression('main',</span> <span class="pre">(10,),</span> <span class="pre">{})</span></code>.</p></li>
<li><p>It creates a cache key <code class="docutils literal notranslate"><span class="pre">(task=main,</span> <span class="pre">version='1',</span> <span class="pre">args=10)</span></code> and finds a cache hit, namely <code class="docutils literal notranslate"><span class="pre">TaskExpression('step2',</span> <span class="pre">(TaskExpression('task1',</span> <span class="pre">(10,)</span> <span class="pre">{}),),</span> <span class="pre">{})</span></code>.</p></li>
<li><p>Due to having a cached result, the scheduler skips executing the function <code class="docutils literal notranslate"><span class="pre">main(10)</span></code>, and proceeds to evaluating the expression tree.</p></li>
<li><p>When the scheduler evaluates <code class="docutils literal notranslate"><span class="pre">TaskExpression('task1',</span> <span class="pre">(10,)</span> <span class="pre">{}),)</span></code>, it notices that the cache key <code class="docutils literal notranslate"><span class="pre">(task=step1,</span> <span class="pre">version='2',</span> <span class="pre">args=10)</span></code> has not been seen before, and so it executes <code class="docutils literal notranslate"><span class="pre">task1(10)</span></code> to get the result <code class="docutils literal notranslate"><span class="pre">12</span></code>.</p></li>
<li><p>The second sub-expression <code class="docutils literal notranslate"><span class="pre">TaskExpression('task2',</span> <span class="pre">(12,),</span> <span class="pre">{})</span></code> has also not been seen before, and so it executes as well.</p></li>
<li><p>Ultimately the scheduler returns the concrete value <code class="docutils literal notranslate"><span class="pre">24</span></code>.</p></li>
</ul>
<p>The end result of this process is that redun correctly skips re-execution of unchanged high level tasks, such as <code class="docutils literal notranslate"><span class="pre">main</span></code>, but properly re-executes updated deeply nested tasks, such as <code class="docutils literal notranslate"><span class="pre">task1</span></code>. It is quite common in large programs that the upper level tasks mostly perform routing of arguments and results, and the lower level tasks perform the actual work. Routing frequently is unaffected by the actual data or implementations of the lower level tasks, so being able to skip re-execution of high level tasks is an important optimization.</p>
</section>
<section id="file-reactivity">
<h3>File reactivity<a class="headerlink" href="#file-reactivity" title="Permalink to this headline">#</a></h3>
<p>A common use case for workflow engines is to read and write to files, either stored locally or remotely (object storage, S3, etc). Files can be a tricky data type to accommodate in a purely functional setting, because the contents of files can change outside of our control. Ideally, we would like our workflow engine to react to those changes. For example, we would want to re-execute our workflow when:</p>
<ul class="simple">
<li><p>An input file changes its contents, and now we want to re-execute the tasks that read that input file so we can regenerate our downstream results.</p></li>
<li><p>An output file has changed or been deleted, and now we want to re-execute the task that wrote that file so that we can reproduce the output file.</p></li>
</ul>
<p>These behaviors are what we typically get from a workflow engine like <code class="docutils literal notranslate"><span class="pre">make</span></code>. Changing a C source code file, gets detected by <code class="docutils literal notranslate"><span class="pre">make</span></code> and it recompiles the source file. Deleting the final compiled program, forces <code class="docutils literal notranslate"><span class="pre">make</span></code> to regenerate the program from earlier steps (source compiling, object linking, etc). In data science workflows, we would often like to re-execute a calculation when the input CSV changes, or if an output plot was deleted or altered.</p>
<p>redun achieves this behavior by wrapping file input/output (IO) in a special class called <code class="docutils literal notranslate"><span class="pre">redun.File</span></code>. Here, is an example usage:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">csv</span>

<span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">File</span>

<span class="n">redun_namespace</span> <span class="o">=</span> <span class="s2">"examples.files"</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">input_file</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>

    <span class="c1"># result = calculation with rows...</span>

    <span class="n">output_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">'output.txt'</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">output</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">input_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">'input.csv'</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">File()</span></code> constructor takes a path as an argument (it can be a local file or any <a class="reference external" href="https://filesystem-spec.readthedocs.io/en/latest/">fsspec</a> supported remote URL, such as S3 or GCP.) and provides familiar file IO methods such as <code class="docutils literal notranslate"><span class="pre">open()</span></code> and <code class="docutils literal notranslate"><span class="pre">close()</span></code>. <code class="docutils literal notranslate"><span class="pre">open()</span></code> gives a usual file stream that we can read or write from. The special logic happens when a File is returned from a task or passed as an argument. In those situations the File is hashed and the File reference is recorded in the call graph. By default, redun performs a fast pseudo hashing of a file by hashing the triple (file path, byte size, modification time) (a technique used by other workflow engines, such as <a class="reference external" href="https://www.nextflow.io/">Nextflow</a>).</p>
<p>When a change is made to the input file <code class="docutils literal notranslate"><span class="pre">input.csv</span></code>, redun will notice that the File’s hash has changed and will consider it a new value that requires <code class="docutils literal notranslate"><span class="pre">process_data()</span></code> to re-execute. This is very similar to the caching logic for any other task argument.</p>
<p>However, if <code class="docutils literal notranslate"><span class="pre">output.txt</span></code> is deleted or altered, redun does something special. When redun retrieves from the call graph a previously cached <code class="docutils literal notranslate"><span class="pre">output_file</span></code> result, it compares the recorded hash with a new hash computed from the current file in the filesystem. If the hashes don’t match, the cached File is considered <em>invalid</em>, and it is considered a cache miss. This will force <code class="docutils literal notranslate"><span class="pre">process_data()</span></code> to re-execute.</p>
<p>We call File an example of an <em>External Value</em>, because Files can change in an external system, such as a file syetsm outside our control. Consequently, when we fetch a File from the cache, we must first check whether its still valid (i.e. cached hash matches current hash from filesystem).</p>
<p>redun naturally understands which Files are used for input vs output based on whether they are passed as arguments or returned as results, respectively. Note, it can lead to confusing behavior to pass a File as input to a Task, alter it, and then return it as a result. That would lead to the recorded call node to be immediately out of date (its input File hash doesn’t match anymore). The user should be careful to avoid this pattern.</p>
</section>
<section id="shell-scripting">
<h3>Shell scripting<a class="headerlink" href="#shell-scripting" title="Permalink to this headline">#</a></h3>
<p>It is common, especially in bioinformatics, to use workflow engines to combine together unix programs into a computational pipeline. Typically, each program exchanges data with each other through input and output files. redun provides several features to ease the calling of programs through scripts and managing their input and output files.</p>
<section id="script-tasks">
<h4>Script tasks<a class="headerlink" href="#script-tasks" title="Permalink to this headline">#</a></h4>
<p>A <em>script task</em> is a special task in redun whose definition is a shell script as opposed to a python function. Script tasks are defined by passing the task option <code class="docutils literal notranslate"><span class="pre">script=True</span></code> in the <code class="docutils literal notranslate"><span class="pre">@task()</span></code> decorator and returning a string containing a shell script.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">script</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">task1</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"""</span>
<span class="s2">    mkdir dir</span>
<span class="s2">    cd dir</span>
<span class="s2">    my-prog </span><span class="si">{</span><span class="n">arg1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">arg2</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    """</span>
</pre></div>
</div>
<p>The user can use even use f-string interpolation to conveniently pass task arguments (e.g. <code class="docutils literal notranslate"><span class="pre">arg1</span></code> and <code class="docutils literal notranslate"><span class="pre">arg2</span></code>) to the script.</p>
<p>The return value of a script task is the standard output of the script. Here, is an example of a normal task, <code class="docutils literal notranslate"><span class="pre">grep_files()</span></code> calling a script task <code class="docutils literal notranslate"><span class="pre">grep()</span></code>:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">script</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">File</span><span class="p">):</span>
    <span class="c1"># Calls grep to find pattern in a file.</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"""</span>
<span class="s2">    grep </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    """</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">grep_files</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">File</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># Calls grep to find a pattern on a list of files.</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>  <span class="c1"># Result is stdout of `grep {pattern} {file.path}`</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">matches</span>
</pre></div>
</div>
<p>Scripts are assumed to be <code class="docutils literal notranslate"><span class="pre">sh</span></code> scripts by default, but custom interpreters (e.g. <code class="docutils literal notranslate"><span class="pre">python</span></code>) can be specified using <code class="docutils literal notranslate"><span class="pre">#!</span></code> in the first line.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">script</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">File</span><span class="p">):</span>
    <span class="c1"># Calls grep to find pattern in a file.</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"""</span>
<span class="s2">    #!/usr/bin/python</span>
<span class="s2">    print('Hello, World!')</span>
<span class="s2">    """</span>
</pre></div>
</div>
<p>Feel free to indent lines to match the surrounding code. redeun uses <a class="reference external" href="https://docs.python.org/3/library/textwrap.html#textwrap.dedent">dedent()</a> to remove leading whitespace in scripts.</p>
</section>
<section id="file-staging">
<h4>File staging<a class="headerlink" href="#file-staging" title="Permalink to this headline">#</a></h4>
<p>When defining script tasks that run on a remote execution environment (e.g. AWS Batch), it is common to have to copy input files from a cloud storage location (e.g. S3) to the compute node and similarly copy output files from the compute node back to cloud storage. We call this file staging and unstaging, respectively.</p>
<p>Manually performing file staging would look something like this:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">script</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">align_dna_reads_to_genome</span><span class="p">(</span><span class="n">input_reads_file</span><span class="p">:</span> <span class="n">File</span><span class="p">,</span> <span class="n">output_align_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">"""</span>
<span class="s2">        # Stage input file from cloud storage to compute node (local disk).</span>
<span class="s2">        aws s3 cp </span><span class="si">{</span><span class="n">input_reads_file</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> reads.fastq.gz</span>

<span class="s2">        # Run a unix program that processes input reads.fastq.gz and outputs sample.aln.bam</span>
<span class="s2">        run-bwamem </span><span class="se">\</span>
<span class="s2">            -R "@RG</span><span class="se">\\</span><span class="s2">tID:</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="se">\\</span><span class="s2">tSM:</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="se">\\</span><span class="s2">tPL:illumina" </span><span class="se">\</span>
<span class="s2">            -o sample </span><span class="se">\</span>
<span class="s2">            -H </span><span class="se">\</span>
<span class="s2">            genome.fa </span><span class="se">\</span>
<span class="s2">            reads.fastq.gz</span>

<span class="s2">        # Unstage output file back to cloud storage.       </span>
<span class="s2">        aws s3 cp sample.aln.bam </span><span class="si">{</span><span class="n">output_align_path</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    """</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Example of calling script task.</span>
    <span class="n">input_reads_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">'s3://bucket/a/b/c/100.fastq.gz'</span><span class="p">)</span>
    <span class="n">output_align_path</span> <span class="o">=</span> <span class="s1">'s3://bucket/a/b/c/100.aln.bam'</span>
    <span class="n">sample_id</span> <span class="o">=</span> <span class="s1">'100'</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="n">align_dna_reads_to_genome</span><span class="p">(</span><span class="n">input_reads_file</span><span class="p">,</span> <span class="n">output_align_path</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="c1"># After execution, the file 's3://bucket/a/b/c/100.aln.bam' will be created.</span>
    <span class="k">return</span> <span class="n">stdout</span>
</pre></div>
</div>
<p>The above code should work perfectly fine, however, manually writing input/output staging commands can be tedious. redun provides a utility function <code class="docutils literal notranslate"><span class="pre">script()</span></code> that can further simplify file staging.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">File</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">align_dna_reads_to_genome</span><span class="p">(</span><span class="n">input_reads_file</span><span class="p">:</span> <span class="n">File</span><span class="p">,</span> <span class="n">output_align_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">script</span><span class="p">(</span><span class="sa">f</span><span class="s2">"""</span>
<span class="s2">        # Run a unix program that processes input reads.fastq.gz and outputs sample.aln.bam</span>
<span class="s2">        run-bwamem </span><span class="se">\</span>
<span class="s2">            -R "@RG</span><span class="se">\\</span><span class="s2">tID:</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="se">\\</span><span class="s2">tSM:</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="se">\\</span><span class="s2">tPL:illumina" </span><span class="se">\</span>
<span class="s2">            -o sample </span><span class="se">\</span>
<span class="s2">            -H </span><span class="se">\</span>
<span class="s2">            genome.fa </span><span class="se">\</span>
<span class="s2">            reads.fastq.gz</span>
<span class="s2">        """</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">input_reads_file</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="s1">'reads.fastq.gz'</span><span class="p">)],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="n">File</span><span class="p">(</span><span class="n">output_align_path</span><span class="p">)</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="s1">'sample.aln.bam'</span><span class="p">),</span>
   <span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Example of calling script task.</span>
    <span class="n">input_reads_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">'s3://bucket/a/b/c/100.fastq.gz'</span><span class="p">)</span>
    <span class="n">output_align_path</span> <span class="o">=</span> <span class="s1">'s3://bucket/a/b/c/100.aln.bam'</span>
    <span class="n">sample_id</span> <span class="o">=</span> <span class="s1">'100'</span>
    <span class="n">output_align_file</span> <span class="o">=</span> <span class="n">align_dna_reads_to_genome</span><span class="p">(</span><span class="n">input_reads_file</span><span class="p">,</span> <span class="n">output_align_path</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_align_file</span>
</pre></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">script()</span></code> takes a shell script, plus two additional arguments <code class="docutils literal notranslate"><span class="pre">inputs</span></code> and <code class="docutils literal notranslate"><span class="pre">outputs</span></code> that specify <code class="docutils literal notranslate"><span class="pre">StagingFile</span></code>s. A <code class="docutils literal notranslate"><span class="pre">StagingFile</span></code> is a pair of local and remote <code class="docutils literal notranslate"><span class="pre">File</span></code>s. <code class="docutils literal notranslate"><span class="pre">script()</span></code> will copy inputs from remote file to local file, and outputs from local file to remote file. <code class="docutils literal notranslate"><span class="pre">StagingFile</span></code>s can be defined using the <code class="docutils literal notranslate"><span class="pre">File.stage()</span></code> method:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">File</span><span class="p">(</span><span class="n">remote_path</span><span class="p">)</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
</pre></div>
</div>
<p>The final result of <code class="docutils literal notranslate"><span class="pre">script()</span></code> will be the same shape of <code class="docutils literal notranslate"><span class="pre">outputs</span></code>, with all <code class="docutils literal notranslate"><span class="pre">StagingFile</span></code>s replaced by their remote <code class="docutils literal notranslate"><span class="pre">File</span></code>s. This allows easy definition of multiple output files:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">File</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">align_dna_reads_to_genome</span><span class="p">(</span>
        <span class="n">input_reads1_file</span><span class="p">:</span> <span class="n">File</span><span class="p">,</span>
        <span class="n">input_reads2_file</span><span class="p">:</span> <span class="n">File</span><span class="p">,</span>
        <span class="n">output_align_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_metrics_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">sample_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
    <span class="k">return</span> <span class="n">script</span><span class="p">(</span><span class="sa">f</span><span class="s2">"""</span>
<span class="s2">        # Run a unix program that processes input reads.fastq.gz and outputs sample.aln.bam</span>
<span class="s2">        run-bwamem </span><span class="se">\</span>
<span class="s2">            -R "@RG</span><span class="se">\\</span><span class="s2">tID:</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="se">\\</span><span class="s2">tSM:</span><span class="si">{</span><span class="n">sample_id</span><span class="si">}</span><span class="se">\\</span><span class="s2">tPL:illumina" </span><span class="se">\</span>
<span class="s2">            -o sample </span><span class="se">\</span>
<span class="s2">            -H </span><span class="se">\</span>
<span class="s2">            genome.fa </span><span class="se">\</span>
<span class="s2">            reads1.fastq.gz </span><span class="se">\</span>
<span class="s2">            reads2.fastq.gz</span>

<span class="s2">        # Collect some metrics about sample.aln.bam</span>
<span class="s2">        samtools depth -a sample.aln.bam &gt; sample.depth_out.txt</span>
<span class="s2">        """</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">input_reads1_file</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="s1">'reads1.fastq.gz'</span><span class="p">)</span>
            <span class="n">input_reads2_file</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="s1">'reads2.fastq.gz'</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">'align'</span><span class="p">:</span> <span class="n">File</span><span class="p">(</span><span class="n">output_align_path</span><span class="p">)</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="s1">'sample.aln.bam'</span><span class="p">),</span>
            <span class="s1">'metrics'</span><span class="p">:</span> <span class="n">File</span><span class="p">(</span><span class="n">output_metrics_path</span><span class="p">)</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="s1">'sample.depth_out.txt'</span><span class="p">),</span>
        <span class="p">}</span>
   <span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Example of calling script task.</span>
    <span class="n">input_reads1_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">'s3://bucket/a/b/c/100.1.fastq.gz'</span><span class="p">)</span>
    <span class="n">input_reads2_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s1">'s3://bucket/a/b/c/100.2.fastq.gz'</span><span class="p">)</span>
    <span class="n">output_align_path</span> <span class="o">=</span> <span class="s1">'s3://bucket/a/b/c/100.aln.bam'</span>
    <span class="n">output_metrics_path</span> <span class="o">=</span> <span class="s1">'s3://bucket/a/b/c/100.depth_out.txt'</span>
    <span class="n">sample_id</span> <span class="o">=</span> <span class="s1">'100'</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">align_dna_reads_to_genome</span><span class="p">(</span>
        <span class="n">input_reads1_file</span><span class="p">,</span> <span class="n">input_reads2_file</span><span class="p">,</span>
        <span class="n">output_align_path</span><span class="p">,</span> <span class="n">output_metrics_path</span><span class="p">,</span>
        <span class="n">sample_id</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Returns</span>
    <span class="c1"># {</span>
    <span class="c1">#    'align': File('s3://bucket/a/b/c/100.aln.bam'),</span>
    <span class="c1">#    'metrics': File('s3://bucket/a/b/c/100.depth_out.txt'),</span>
    <span class="c1"># }</span>

    <span class="c1"># Use lazy key access to pass only the alignment to another task.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">post_process_align</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">'align'</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="working-with-values">
<h2>Working with Values<a class="headerlink" href="#working-with-values" title="Permalink to this headline">#</a></h2>
<p>Values is the general term redun uses to refer to task arguments and results. Below, we describe some of the special treatment redun uses to enable expressive value dataflow.</p>
<section id="nested-values">
<h3>Nested values<a class="headerlink" href="#nested-values" title="Permalink to this headline">#</a></h3>
<p>It is common in workflow frameworks to allow a task to have multiple outputs. This is useful when different outputs need to be routed to their own downstream tasks. redun aims to be pythonic, and in Python functions return one value. However, return values can be container types such as lists, tuples, dict, etc. In that spirit, redun gives special treatment to the builtin Python containers (list, tuple, dict, namedtuple, set) in order to provide features like multiple outputs and inputs. In redun, we call a value built up from possibly multiple nested container types, a <em>nested value</em>. Take the following code for example:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">run_calculation</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># Perform calculation...</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">'output1'</span><span class="p">:</span> <span class="n">output1</span><span class="p">,</span>
        <span class="s1">'output_list'</span><span class="p">:</span> <span class="p">[</span><span class="n">output_a</span><span class="p">,</span> <span class="n">output_b</span><span class="p">,</span> <span class="n">output_c</span><span class="p">]</span>
    <span class="p">}</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step2</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="c1"># Process item...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step3</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># Process items...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="c1"># Get data from somewhere...</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">run_calculation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">step2</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'output1'</span><span class="p">])</span>
    <span class="n">result3</span> <span class="o">=</span> <span class="n">step3</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'output_list'</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">result2</span><span class="p">,</span> <span class="n">result3</span><span class="p">]</span>
</pre></div>
</div>
<p>From the lazy-evaluation section, we know that <code class="docutils literal notranslate"><span class="pre">run_calculation(data)</span></code> returns an Expression, which we usually have to pass to another task in order to obtained a resolved concrete value (i.e. “look inside”). However, redun allows lazy attribute access for nested values (such as dict). For example, the above <code class="docutils literal notranslate"><span class="pre">outputs['output1']</span></code> returns another Expression:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
<span class="c1"># TaskExpression('run_calculation', (data,), {})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="s1">'output1'</span><span class="p">])</span>
<span class="c1"># SimpleExpression(</span>
<span class="c1">#   'getitem',</span>
<span class="c1">#   (</span>
<span class="c1">#     TaskExpression('run_calculation', (data,), {}),</span>
<span class="c1">#     'output1'</span>
<span class="c1">#   ),</span>
<span class="c1">#   {}</span>
<span class="c1"># )</span>
</pre></div>
</div>
<p>By the time this expression is passed to <code class="docutils literal notranslate"><span class="pre">step2()</span></code> it will evaluate to the concrete value <code class="docutils literal notranslate"><span class="pre">output1</span></code> from <code class="docutils literal notranslate"><span class="pre">run_calculation()</span></code>. redun implements a number of builtin simple expressions, such as ‘getitem’ (<code class="docutils literal notranslate"><span class="pre">expr[key]</span></code>), ‘getattr’ (<code class="docutils literal notranslate"><span class="pre">expr.attr</span></code>), and ‘call’ (<code class="docutils literal notranslate"><span class="pre">expr(arg1,</span> <span class="pre">arg2)</span></code>).</p>
<p>Also multiple lazy calls can be chained such as <code class="docutils literal notranslate"><span class="pre">outputs['output_list'][:2]</span></code>. This lazy-evaluation technique allows us to define dataflows even for the case of multiple outputs.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">main()</span></code> task, we return a nested value that contains Expression, <code class="docutils literal notranslate"><span class="pre">result2</span></code> and <code class="docutils literal notranslate"><span class="pre">result3</span></code>. redun will recurse into nested values to detect additional Expressions that must be resolved before <code class="docutils literal notranslate"><span class="pre">main()</span></code> can fully resolve.</p>
<p>Expressions can also be nested in arguments:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">task1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">adder</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">task1</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">adder</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">values</span></code> in <code class="docutils literal notranslate"><span class="pre">main()</span></code> is actually a list of Expressions. The redun scheduler knows to wait on the evaluation of all expressions within a nested value before using it as an argument to a task (<code class="docutils literal notranslate"><span class="pre">adder</span></code>).</p>
</section>
<section id="recursion">
<h3>Recursion<a class="headerlink" href="#recursion" title="Permalink to this headline">#</a></h3>
<p>Another example of the generality of our call graph recording technique is the ability to define workflows with recursion, which many workflow engines cannot express. Take the follow example:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>This computes the n<sup>th</sup> <a class="reference external" href="https://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci number</a> using recursion. redun doesn’t prevent a task calling itself, and in fact due to the memoization, this calculation will be done in linear time instead of exponential.</p>
</section>
<section id="tasks-as-first-class-values">
<h3>Tasks as first class values<a class="headerlink" href="#tasks-as-first-class-values" title="Permalink to this headline">#</a></h3>
<p>As we saw in the recursion section, redun can handle complex dataflows, such as recursion. It also can implement  higher order tasks (tasks that receive or return other tasks) in order provide very reusable workflow components.</p>
<p>As an example, let’s say we had a pipeline of steps:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">pipeline</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">step1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">step2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">step3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>Next, let’s say we have several possible tasks for step2 and we wanted to swap them in and out in different situations. To do that, we could make step2 an input to pipeline.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step2a</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step2b</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">step3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">pipeline</span><span class="p">(</span><span class="n">step2</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">step1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">step2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">step3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">pipeline</span><span class="p">(</span><span class="n">step2a</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
        <span class="n">pipeline</span><span class="p">(</span><span class="n">step2b</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>Tasks can also be used as return values.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># def step1, step2a, step2b, step3, pipeline</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">pick_step2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">step2a</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">step2b</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">step2</span> <span class="o">=</span> <span class="n">pick_step</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">step2</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="data-provenance">
<h2>Data provenance<a class="headerlink" href="#data-provenance" title="Permalink to this headline">#</a></h2>
<section id="call-graphs">
<h3>Call graphs<a class="headerlink" href="#call-graphs" title="Permalink to this headline">#</a></h3>
<img src="redun-call-graph.svg" width="100%"/>
<p>Depicted above is an example call graph and job tree (left) for an execution of a workflow (right). When each task is called, a CallNode is recorded along with all the Values used as arguments and return value. As tasks (<code class="docutils literal notranslate"><span class="pre">main</span></code>) call child tasks, children CallNodes are recorded (<code class="docutils literal notranslate"><span class="pre">task1</span></code> and <code class="docutils literal notranslate"><span class="pre">task2</span></code>). “Horizontal” dataflow is also recorded between sibling tasks, such as <code class="docutils literal notranslate"><span class="pre">task1</span></code> and <code class="docutils literal notranslate"><span class="pre">task2</span></code>. Each node in the call graph is identified by a unique hash and each Job and Execution is identified by a unique UUID. This information is stored by default in the redun database <code class="docutils literal notranslate"><span class="pre">.redun/redun.db</span></code>.</p>
</section>
<section id="querying-call-graphs">
<h3>Querying call graphs<a class="headerlink" href="#querying-call-graphs" title="Permalink to this headline">#</a></h3>
<p>Every time redun executes a workflow, it records the execution as a CallGraph. The <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">log</span></code> command can be used to query past executions and walk through the CallGraph. Here we’ll walk through the <code class="docutils literal notranslate"><span class="pre">examples/compile/</span></code> example. The workflow script should look something like this:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">File</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">c_file</span><span class="p">:</span> <span class="n">File</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Compile one C file into an object file.</span>
<span class="sd">    """</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"gcc -c </span><span class="si">{c_file}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_file</span><span class="o">=</span><span class="n">c_file</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">c_file</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.c'</span><span class="p">,</span> <span class="s1">'.o'</span><span class="p">))</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">prog_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">o_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">File</span><span class="p">]):</span>
    <span class="sd">"""</span>
<span class="sd">    Link several object files together into one program.</span>
<span class="sd">    """</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"gcc -o </span><span class="si">{prog_path}</span><span class="s2"> </span><span class="si">{o_files}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">prog_path</span><span class="o">=</span><span class="n">prog_path</span><span class="p">,</span>
        <span class="n">o_files</span><span class="o">=</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o_file</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">o_file</span> <span class="ow">in</span> <span class="n">o_files</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">prog_path</span><span class="p">)</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">make_prog</span><span class="p">(</span><span class="n">prog_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">c_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">File</span><span class="p">]):</span>
    <span class="sd">"""</span>
<span class="sd">    Compile one program from its source C files.</span>
<span class="sd">    """</span>
    <span class="n">o_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">compile</span><span class="p">(</span><span class="n">c_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c_file</span> <span class="ow">in</span> <span class="n">c_files</span>
    <span class="p">]</span>
    <span class="n">prog_file</span> <span class="o">=</span> <span class="n">link</span><span class="p">(</span><span class="n">prog_path</span><span class="p">,</span> <span class="n">o_files</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prog_file</span>


<span class="c1"># Definition of programs and their source C files.</span>
<span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'prog'</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">File</span><span class="p">(</span><span class="s1">'prog.c'</span><span class="p">),</span>
        <span class="n">File</span><span class="p">(</span><span class="s1">'lib.c'</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="s1">'prog2'</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">File</span><span class="p">(</span><span class="s1">'prog2.c'</span><span class="p">),</span>
        <span class="n">File</span><span class="p">(</span><span class="s1">'lib.c'</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">}</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="n">files</span> <span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">File</span><span class="p">]]</span><span class="o">=</span><span class="n">files</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Top-level task for compiling all the programs in the project.</span>
<span class="sd">    """</span>
    <span class="n">progs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">make_prog</span><span class="p">(</span><span class="n">prog_path</span><span class="p">,</span> <span class="n">c_files</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prog_path</span><span class="p">,</span> <span class="n">c_files</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">progs</span>
</pre></div>
</div>
<p>For reference, these source files have the following contents:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// lib.c</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">get_message</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"Hello, World!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>


<span class="c1">// prog.c</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">get_message</span><span class="p">();</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_message</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"prog1: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>


<span class="c1">// prog2.c</span>
<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">get_message</span><span class="p">();</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_message</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"prog2: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Let’s execute this workflow using <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">run</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">run</span> <span class="n">make</span><span class="o">.</span><span class="n">py</span> <span class="n">make</span>

<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">make</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">fe2a2a7d</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">make</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'files'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'prog'</span><span class="p">:</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">574</span><span class="n">d39e642f407119c2661559cea39d491bd3dc1</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">a08d53bbaf62e480408552a2d3680e604f4cff50</span><span class="p">)],</span> <span class="s1">'prog2'</span><span class="p">:</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">b262cdb5130</span><span class="o">...</span><span class="p">)</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">make_prog</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">e69b7ae9</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">make_prog</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'prog'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">574</span><span class="n">d39e642f407119c2661559cea39d491bd3dc1</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">a08d53bbaf62e480408552a2d3680e604f4cff50</span><span class="p">)]),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">make_prog</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">045</span><span class="n">f3cca</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">make_prog</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'prog2'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">b262cdb5130e8984ed3bb0dba8c83e56173ed702</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">a08d53bbaf62e480408552a2d3680e604f4cff50</span><span class="p">)]),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="nb">compile</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">2872</span><span class="n">aec1</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="nb">compile</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">574</span><span class="n">d39e642f407119c2661559cea39d491bd3dc1</span><span class="p">),),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="nb">compile</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">600</span><span class="n">f6efe</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="nb">compile</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">a08d53bbaf62e480408552a2d3680e604f4cff50</span><span class="p">),),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="nb">compile</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">ee7f4a1a</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="nb">compile</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">b262cdb5130e8984ed3bb0dba8c83e56173ed702</span><span class="p">),),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">link</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">7</span><span class="n">d623fd2</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">link</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'prog'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">ea439e92541937ec0777210367ed8a05ec91dad0</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">ecf0db54c26fd406610d140494ba580740c610e2</span><span class="p">)]),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">link</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">af9f2dad</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">link</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'prog2'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mf">60e8</span><span class="n">a5e97fe8b6064d0655c1eee16ff6dd650946</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">ecf0db54c26fd406610d140494ba580740c610e2</span><span class="p">)]),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">ff7aea3193ee882d1dc69f284d18d3353c97bc11</span><span class="p">),</span>
 <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">e0e9a6701a1cef13d13df62ca492472016e5edc4</span><span class="p">)]</span>
</pre></div>
</div>
<p>This workflow should have compiled and linked two binaries <code class="docutils literal notranslate"><span class="pre">prog</span></code> and <code class="docutils literal notranslate"><span class="pre">prog2</span></code> (Note, you will need gcc installed for this example to work). We should now be able to execute one of the binaries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>./prog

prog1: Hello, World!
</pre></div>
</div>
<p>Now, let’s edit one of the C files to have more exclamation marks!!!!!!</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="gd">--- a/examples/compile/lib.c</span><span class="w"></span>
<span class="gi">+++ b/examples/compile/lib.c</span><span class="w"></span>
<span class="gu">@@ -1,3 +1,3 @@</span><span class="w"></span>
<span class="w"> </span>char *get_message() {<span class="w"></span>
<span class="gd">-    return "Hello, World!\n";</span><span class="w"></span>
<span class="gi">+    return "Hello, World!!!!!!!!\n";</span><span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
</pre></div>
</div>
<p>We rerun our workflow and redun will automatically detect that some (but not all) of the tasks need to re-execute because an input file (lib.c) has changed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">run</span> <span class="n">make</span><span class="o">.</span><span class="n">py</span> <span class="n">make</span>

<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">make</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">3</span><span class="n">bd939d5</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">make</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'files'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'prog'</span><span class="p">:</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">574</span><span class="n">d39e642f407119c2661559cea39d491bd3dc1</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">e8ff8720b689411145e97dec7d0f8ad9b4ee4e38</span><span class="p">)],</span> <span class="s1">'prog2'</span><span class="p">:</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">b262cdb5130</span><span class="o">...</span><span class="p">)</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">make_prog</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">a925dcaa</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">make_prog</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'prog'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">574</span><span class="n">d39e642f407119c2661559cea39d491bd3dc1</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">e8ff8720b689411145e97dec7d0f8ad9b4ee4e38</span><span class="p">)]),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">make_prog</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">8</span><span class="n">f6b3814</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">make_prog</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'prog2'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">b262cdb5130e8984ed3bb0dba8c83e56173ed702</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">e8ff8720b689411145e97dec7d0f8ad9b4ee4e38</span><span class="p">)]),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="nb">compile</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">2872</span><span class="n">aec1</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="nb">compile</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">6</span><span class="n">d665ff5</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="nb">compile</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">e8ff8720b689411145e97dec7d0f8ad9b4ee4e38</span><span class="p">),),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="nb">compile</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="n">ee7f4a1a</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">link</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">3</span><span class="n">fcc3117</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">link</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'prog'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">ea439e92541937ec0777210367ed8a05ec91dad0</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">6370</span><span class="n">c13da0a6ca01177f4b42b043d5cd860351d6</span><span class="p">)]),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Check</span> <span class="n">cache</span> <span class="n">link</span> <span class="p">(</span><span class="n">eval_hash</span><span class="o">=</span><span class="mi">9</span><span class="n">b3784ce</span><span class="p">)</span><span class="o">...</span>
<span class="p">[</span><span class="n">redun</span><span class="p">]</span> <span class="n">Run</span> <span class="n">link</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">'prog2'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mf">60e8</span><span class="n">a5e97fe8b6064d0655c1eee16ff6dd650946</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">6370</span><span class="n">c13da0a6ca01177f4b42b043d5cd860351d6</span><span class="p">)]),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="n">on</span> <span class="n">default</span>
<span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">6</span><span class="n">daae76807abc212f1085b43b76003821314309f</span><span class="p">),</span>
 <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">62</span><span class="n">a3a615ed8e6f5265f76f3603df8f58790ba1d6</span><span class="p">)]</span>
</pre></div>
</div>
<p>We should see our change reflected in the new binary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>./prog

prog1: Hello, World!!!!!!!!
</pre></div>
</div>
<p>Now, let’s look at the call graphs recorded so far. We can list past executions like so:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>redun log

Recent executions:
  Exec a5583da5-3787-4324-86c9-ad988753cd2e <span class="m">2020</span>-06-26 <span class="m">22</span>:21:32:  <span class="nv">args</span><span class="o">=</span>run make.py make
  Exec 3bd1e113-d88f-4671-a996-4b2feb5aa58b <span class="m">2020</span>-06-26 <span class="m">22</span>:15:03:  <span class="nv">args</span><span class="o">=</span>run make.py make
</pre></div>
</div>
<p>Each execution is given a unique id (UUID). To list more information about a specific execution, simply supply it to the <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">log</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">log</span> <span class="n">a5583da5</span><span class="o">-</span><span class="mi">3787</span><span class="o">-</span><span class="mi">4324</span><span class="o">-</span><span class="mi">86</span><span class="n">c9</span><span class="o">-</span><span class="n">ad988753cd2e</span>

<span class="n">Exec</span> <span class="n">a5583da5</span><span class="o">-</span><span class="mi">3787</span><span class="o">-</span><span class="mi">4324</span><span class="o">-</span><span class="mi">86</span><span class="n">c9</span><span class="o">-</span><span class="n">ad988753cd2e</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">args</span><span class="o">=</span><span class="n">run</span> <span class="n">make</span><span class="o">.</span><span class="n">py</span> <span class="n">make</span>
  <span class="n">Job</span> <span class="mi">1604</span><span class="n">f4c0</span><span class="o">-</span><span class="n">aca0</span><span class="o">-</span><span class="mi">437</span><span class="n">b</span><span class="o">-</span><span class="n">b5ae</span><span class="o">-</span><span class="mi">2741954</span><span class="n">fafbd</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">task</span><span class="p">:</span> <span class="n">make</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="mi">0</span><span class="n">d9dca7d</span><span class="p">,</span> <span class="n">call_node</span><span class="p">:</span> <span class="n">c2de7619</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="kc">False</span>
    <span class="n">Job</span> <span class="mi">7</span><span class="n">bc38754</span><span class="o">-</span><span class="mi">8741</span><span class="o">-</span><span class="mi">4302</span><span class="o">-</span><span class="n">ae81</span><span class="o">-</span><span class="mi">08</span><span class="n">d043b345aa</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">task</span><span class="p">:</span> <span class="n">make_prog</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="mi">16</span><span class="n">aa763c</span><span class="p">,</span> <span class="n">call_node</span><span class="p">:</span> <span class="mi">88</span><span class="n">f47605</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="kc">False</span>
      <span class="n">Job</span> <span class="mi">1</span><span class="n">f4b4a76</span><span class="o">-</span><span class="n">a920</span><span class="o">-</span><span class="mi">4</span><span class="n">b6a</span><span class="o">-</span><span class="mi">8323</span><span class="o">-</span><span class="mi">1</span><span class="n">df9876354e3</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">task</span><span class="p">:</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="n">d2b031e4</span><span class="p">,</span> <span class="n">call_node</span><span class="p">:</span> <span class="n">fedc6cdc</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="kc">True</span>
      <span class="n">Job</span> <span class="n">bfa81ca0</span><span class="o">-</span><span class="mi">1897</span><span class="o">-</span><span class="mf">4e88</span><span class="o">-</span><span class="mi">8</span><span class="n">be9</span><span class="o">-</span><span class="mi">030941</span><span class="n">dae648</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">task</span><span class="p">:</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="n">d2b031e4</span><span class="p">,</span> <span class="n">call_node</span><span class="p">:</span> <span class="mi">7872899</span><span class="n">b</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="kc">False</span>
      <span class="n">Job</span> <span class="mi">96681441</span><span class="o">-</span><span class="n">e186</span><span class="o">-</span><span class="mi">42</span><span class="n">f7</span><span class="o">-</span><span class="mf">9e99</span><span class="o">-</span><span class="mi">663</span><span class="n">fc0d0d08c</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">task</span><span class="p">:</span> <span class="n">link</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="n">e73b3cd2</span><span class="p">,</span> <span class="n">call_node</span><span class="p">:</span> <span class="mi">1</span><span class="n">ddb7325</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="kc">False</span>
    <span class="n">Job</span> <span class="n">e0109842</span><span class="o">-</span><span class="mi">8</span><span class="n">a69</span><span class="o">-</span><span class="mi">4</span><span class="n">a4c</span><span class="o">-</span><span class="n">b2c6</span><span class="o">-</span><span class="mi">9</span><span class="n">b97bfd35b43</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">task</span><span class="p">:</span> <span class="n">make_prog</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="mi">16</span><span class="n">aa763c</span><span class="p">,</span> <span class="n">call_node</span><span class="p">:</span> <span class="mf">4453e6</span><span class="n">cd</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="kc">False</span>
      <span class="n">Job</span> <span class="mi">94830</span><span class="n">f60</span><span class="o">-</span><span class="n">acaa</span><span class="o">-</span><span class="mi">4</span><span class="n">b6b</span><span class="o">-</span><span class="mi">9</span><span class="n">b22</span><span class="o">-</span><span class="n">f4572c64f85b</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">task</span><span class="p">:</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="n">d2b031e4</span><span class="p">,</span> <span class="n">call_node</span><span class="p">:</span> <span class="mi">1</span><span class="n">dc10a1c</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="kc">True</span>
      <span class="n">Job</span> <span class="mi">7935</span><span class="n">a494</span><span class="o">-</span><span class="mi">01</span><span class="n">f6</span><span class="o">-</span><span class="mi">47</span><span class="n">ff</span><span class="o">-</span><span class="mi">8657</span><span class="o">-</span><span class="n">b8877bfe1e84</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span>  <span class="n">task</span><span class="p">:</span> <span class="n">link</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="n">e73b3cd2</span><span class="p">,</span> <span class="n">call_node</span><span class="p">:</span> <span class="n">bab7987a</span><span class="p">,</span> <span class="n">cached</span><span class="p">:</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Now, we can see the tree of Jobs and information about each one, such as the task, task_hash, CallNode hash, and whether the result was cached. To display information about any specific object (Job, Task, CallNode) simply use <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">log</span> <span class="pre">&lt;id_or_hash_prefix&gt;</span></code>. We can get more information about the link Task (<code class="docutils literal notranslate"><span class="pre">e73b3cd2</span></code>) like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">log</span> <span class="n">e73b3cd2</span>

<span class="n">Task</span> <span class="n">link</span> <span class="n">e73b3cd20246b559ac2b9c2933efe953612cc3ab</span>
    <span class="n">First</span> <span class="n">job</span> <span class="mi">88</span><span class="n">eb9fd6</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">26</span> <span class="mi">22</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mf">07.424194</span>

    <span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">prog_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">o_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">File</span><span class="p">]):</span>
        <span class="sd">"""</span>
<span class="sd">        Link several object files together into one program.</span>
<span class="sd">        """</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"gcc -o </span><span class="si">{prog_path}</span><span class="s2"> </span><span class="si">{o_files}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prog_path</span><span class="o">=</span><span class="n">prog_path</span><span class="p">,</span>
            <span class="n">o_files</span><span class="o">=</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o_file</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">o_file</span> <span class="ow">in</span> <span class="n">o_files</span><span class="p">),</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">prog_path</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we see the source code of the task at the time it was run. We can also get more information about the CallNode (<code class="docutils literal notranslate"><span class="pre">bab7987a</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">log</span> <span class="n">bab7987a</span>

<span class="n">CallNode</span> <span class="n">bab7987ae6157f5dea825730e8020470a41c8f0c</span> <span class="n">task_name</span><span class="p">:</span> <span class="n">link</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="n">e73b3cd2</span>
  <span class="n">Result</span><span class="p">:</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">62</span><span class="n">a3a615ed8e6f5265f76f3603df8f58790ba1d6</span><span class="p">)</span>
  <span class="n">Parent</span> <span class="n">CallNodes</span><span class="p">:</span>
    <span class="n">CallNode</span> <span class="mf">4453e6</span><span class="n">cd53c7f1c92dedebcd05e73a19b0ef08d9</span> <span class="n">task_name</span><span class="p">:</span> <span class="n">make_prog</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">:</span> <span class="mi">16</span><span class="n">aa763c</span>
</pre></div>
</div>
<p>We can also query by file name. Which CallNode created file <code class="docutils literal notranslate"><span class="pre">prog</span></code>?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">log</span> <span class="n">prog</span>

<span class="n">File</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'6daae768'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">'prog'</span><span class="p">):</span>
  <span class="o">-</span> <span class="n">Produced</span> <span class="n">by</span> <span class="n">CallNode</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'1ddb7325'</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">'link'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s1">'prog'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">ea439e92541937ec0777210367ed8a05ec91dad0</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">has</span><span class="o">...</span><span class="p">])</span>
  <span class="o">-</span> <span class="n">During</span> <span class="n">Job</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'96681441'</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="s1">'2020-06-26 22:21:32'</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">'link'</span><span class="p">)</span>

  <span class="n">Task</span> <span class="n">link</span> <span class="n">e73b3cd20246b559ac2b9c2933efe953612cc3ab</span>
      <span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">prog_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">o_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">File</span><span class="p">]):</span>
          <span class="sd">"""</span>
<span class="sd">          Link several object files together into one program.</span>
<span class="sd">          """</span>
          <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"gcc -o </span><span class="si">{prog_path}</span><span class="s2"> </span><span class="si">{o_files}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">prog_path</span><span class="o">=</span><span class="n">prog_path</span><span class="p">,</span>
              <span class="n">o_files</span><span class="o">=</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o_file</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">o_file</span> <span class="ow">in</span> <span class="n">o_files</span><span class="p">),</span>
          <span class="p">))</span>
          <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">prog_path</span><span class="p">)</span>
</pre></div>
</div>
<p>Which task read <code class="docutils literal notranslate"><span class="pre">prog.c</span></code>?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">log</span> <span class="n">prog</span><span class="o">.</span><span class="n">c</span>

<span class="n">File</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'574d39e6'</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">'prog.c'</span><span class="p">):</span>
  <span class="o">-</span> <span class="n">Consumed</span> <span class="n">by</span> <span class="n">CallNode</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'fedc6cdc'</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">'compile'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">574</span><span class="n">d39e642f407119c2661559cea39d491bd3dc1</span><span class="p">)])</span>
  <span class="o">-</span> <span class="n">During</span> <span class="n">Job</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'1f4b4a76'</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="s1">'2020-06-26 22:21:32'</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">'compile'</span><span class="p">)</span>

  <span class="n">Task</span> <span class="nb">compile</span> <span class="n">d2b031e48e7f491a3d05a12f243f967517b25236</span>
      <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">c_file</span><span class="p">:</span> <span class="n">File</span><span class="p">):</span>
          <span class="sd">"""</span>
<span class="sd">          Compile one C file into an object file.</span>
<span class="sd">          """</span>
          <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"gcc -c </span><span class="si">{c_file}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_file</span><span class="o">=</span><span class="n">c_file</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">c_file</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.c'</span><span class="p">,</span> <span class="s1">'.o'</span><span class="p">))</span>
</pre></div>
</div>
<p>We can also walk the CallGraph using SQLAlechemy. The command <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">repl</span></code> gives us an interactive read-eval-print-loop (REPL). There is a builtin function <code class="docutils literal notranslate"><span class="pre">query()</span></code> that can retrieve any object by an id prefix:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">repl</span>

<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="n">call_node</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="s1">'bab7987a'</span><span class="p">)</span>
<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="n">call_node</span>
<span class="n">CallNode</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'bab7987a'</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">'link'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s1">'prog2'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mf">60e8</span><span class="n">a5e97fe8b6064d0655c1eee16ff6dd650946</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">h</span><span class="o">...</span><span class="p">])</span>

<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="n">call_node</span><span class="o">.</span><span class="n">value</span>
<span class="n">Value</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'62a3a615'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">62</span><span class="n">a3a615ed8e6f5265f76f3603df8f58790ba1d6</span><span class="p">))</span>

<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="n">call_node</span><span class="o">.</span><span class="n">arguments</span>
<span class="p">[</span><span class="n">Argument</span><span class="p">(</span><span class="n">task_name</span><span class="o">=</span><span class="s1">'link'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">prog2</span><span class="p">),</span> <span class="n">Argument</span><span class="p">(</span><span class="n">task_name</span><span class="o">=</span><span class="s1">'link'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mf">60e8</span><span class="n">a5e97fe8b6064d0655c1eee16ff6dd650946</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="mi">6370</span><span class="n">c13da0a6ca01177f4b42b043d5cd860351d6</span><span class="p">)])]</span>

<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="n">call_node</span><span class="o">.</span><span class="n">parents</span>
<span class="p">[</span><span class="n">CallNode</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'4453e6cd'</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">'make_prog'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s1">'prog2'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">b262cdb5130e8984ed3bb0dba8c83e56173ed702</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="o">...</span><span class="p">])]</span>

<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="n">call_node</span><span class="o">.</span><span class="n">task</span>
<span class="n">Task</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'e73b3cd2'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'link'</span><span class="p">)</span>

<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="nb">print</span><span class="p">(</span><span class="n">call_node</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">prog_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">o_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">File</span><span class="p">]):</span>
    <span class="sd">"""</span>
<span class="sd">    Link several object files together into one program.</span>
<span class="sd">    """</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"gcc -o </span><span class="si">{prog_path}</span><span class="s2"> </span><span class="si">{o_files}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">prog_path</span><span class="o">=</span><span class="n">prog_path</span><span class="p">,</span>
        <span class="n">o_files</span><span class="o">=</span><span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o_file</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">o_file</span> <span class="ow">in</span> <span class="n">o_files</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">prog_path</span><span class="p">)</span>

<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="n">call_node</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">CallNode</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="s1">'4453e6cd'</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">'make_prog'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s1">'prog2'</span><span class="p">,</span> <span class="p">[</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prog2</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">b262cdb5130e8984ed3bb0dba8c83e56173ed702</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="o">...</span><span class="p">])</span>

<span class="p">(</span><span class="n">redun</span><span class="p">)</span> <span class="nb">print</span><span class="p">(</span><span class="n">call_node</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">make_prog</span><span class="p">(</span><span class="n">prog_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">c_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">File</span><span class="p">]):</span>
    <span class="sd">"""</span>
<span class="sd">    Compile one program from its source C files.</span>
<span class="sd">    """</span>
    <span class="n">o_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">compile</span><span class="p">(</span><span class="n">c_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c_file</span> <span class="ow">in</span> <span class="n">c_files</span>
    <span class="p">]</span>
    <span class="n">prog_file</span> <span class="o">=</span> <span class="n">link</span><span class="p">(</span><span class="n">prog_path</span><span class="p">,</span> <span class="n">o_files</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prog_file</span>
</pre></div>
</div>
</section>
<section id="syncing-provenance-data">
<h3>Syncing provenance data<a class="headerlink" href="#syncing-provenance-data" title="Permalink to this headline">#</a></h3>
<p>The redun database (stored in <code class="docutils literal notranslate"><span class="pre">.redun/redun.db</span></code> by default) is designed to be retained for long term storage and analysis. To aid this, the redun CLI provides several commands to make backing up and syncing databases easy.</p>
<section id="repositories">
<h4>Repositories<a class="headerlink" href="#repositories" title="Permalink to this headline">#</a></h4>
<p>Redun organizes data provenance into repositories (“repos” for short) similar to how git organizes code in repos. By default, all provenance is tracked in the default, nameless repository.</p>
<p>Additional named repositories may be added with <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">repo</span> <span class="pre">add</span> <span class="pre">&lt;repo</span> <span class="pre">name&gt;</span> <span class="pre">&lt;config</span> <span class="pre">dir&gt;</span></code>. The configuration for the repository may be local or on S3.</p>
<p>Available repositories can be enumerated with <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">repo</span> <span class="pre">list</span></code>.</p>
<p>Removing repositories via the command-line is not currently supported, but <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">repo</span> <span class="pre">remove</span> <span class="pre">&lt;repo</span> <span class="pre">name&gt;</span></code> will instruct you on how to edit your config file.</p>
</section>
<section id="running-redun-in-other-repositories">
<h4>Running redun in other repositories<a class="headerlink" href="#running-redun-in-other-repositories" title="Permalink to this headline">#</a></h4>
<p>To run redun commands in a different database, <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">--repo</span> <span class="pre">&lt;repo</span> <span class="pre">name&gt;</span> <span class="pre">&lt;command&gt;</span></code> will work for most commands. For example, <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">--repo</span> <span class="pre">foo</span> <span class="pre">log</span> <span class="pre">--task</span></code> will print tasks present in the “foo” repository.</p>
</section>
<section id="synchronizing-repositories">
<h4>Synchronizing repositories<a class="headerlink" href="#synchronizing-repositories" title="Permalink to this headline">#</a></h4>
<p>Just like git, <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">pull</span> <span class="pre">&lt;repo&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">push</span> <span class="pre">&lt;repo&gt;</span></code> will synchronize data to and from remote repositories.</p>
<p>You can also sync from remote to remote: <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">--repo</span> <span class="pre">foo</span> <span class="pre">push</span> <span class="pre">bar</span></code> will push all records from repository “foo” to “bar”. The number of records pushed will be displayed.</p>
</section>
<section id="manual-exports">
<h4>Manual exports<a class="headerlink" href="#manual-exports" title="Permalink to this headline">#</a></h4>
<p>First, the database can be exported to a JSON log format using the <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">export</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redun</span> <span class="n">export</span>

<span class="p">{</span><span class="s2">"_version"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"_type"</span><span class="p">:</span> <span class="s2">"Value"</span><span class="p">,</span> <span class="s2">"value_hash"</span><span class="p">:</span> <span class="s2">"60e8a5e97fe8b6064d0655c1eee16ff6dd650946"</span><span class="p">,</span> <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"redun.File"</span><span class="p">,</span> <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"application/python-pickle"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="s2">"gANjcmVkdW4uZmlsZQpGaWxlCnEAKYFxAX1xAihYBAAAAHBhdGhxA1gHAAAAcHJvZzIub3EEWAQAAABoYXNocQVYKAAAADYwZThhNWU5N2ZlOGI2MDY0ZDA2NTVjMWVlZTE2ZmY2ZGQ2NTA5NDZxBnViLg=="</span><span class="p">,</span> <span class="s2">"subvalues"</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">"file_path"</span><span class="p">:</span> <span class="s2">"prog2.o"</span><span class="p">}</span>
<span class="p">{</span><span class="s2">"_version"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"_type"</span><span class="p">:</span> <span class="s2">"Task"</span><span class="p">,</span> <span class="s2">"task_hash"</span><span class="p">:</span> <span class="s2">"e73b3cd20246b559ac2b9c2933efe953612cc3ab"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"link"</span><span class="p">,</span> <span class="s2">"namespace"</span><span class="p">:</span> <span class="s2">""</span><span class="p">,</span> <span class="s2">"source"</span><span class="p">:</span> <span class="s2">"def link(prog_path: str, o_files: List[File]):</span><span class="se">\n</span><span class="s2">    </span><span class="se">\"\"\"\n</span><span class="s2">    Link several object files together into one program.</span><span class="se">\n</span><span class="s2">    </span><span class="se">\"\"\"\n</span><span class="s2">    print(</span><span class="se">\"</span><span class="s2">linking</span><span class="se">\"</span><span class="s2">)</span><span class="se">\n</span><span class="s2">    os.system(</span><span class="se">\"</span><span class="s2">gcc -o </span><span class="si">{prog_path}</span><span class="s2"> </span><span class="si">{o_files}</span><span class="se">\"</span><span class="s2">.format(</span><span class="se">\n</span><span class="s2">        prog_path=prog_path,</span><span class="se">\n</span><span class="s2">        o_files=' '.join(o_file.path for o_file in o_files),</span><span class="se">\n</span><span class="s2">    ))</span><span class="se">\n</span><span class="s2">    return File(prog_path)</span><span class="se">\n</span><span class="s2">"</span><span class="p">}</span>
<span class="p">{</span><span class="s2">"_version"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"_type"</span><span class="p">:</span> <span class="s2">"CallNode"</span><span class="p">,</span> <span class="s2">"call_hash"</span><span class="p">:</span> <span class="s2">"1dc10a1cbf5696b00d1b6f3e9da2473ba088e033"</span><span class="p">,</span> <span class="s2">"task_name"</span><span class="p">:</span> <span class="s2">"compile"</span><span class="p">,</span> <span class="s2">"task_hash"</span><span class="p">:</span> <span class="s2">"d2b031e48e7f491a3d05a12f243f967517b25236"</span><span class="p">,</span> <span class="s2">"args_hash"</span><span class="p">:</span> <span class="s2">"df25928d0785108768a019cdb8f856c5013c97ec"</span><span class="p">,</span> <span class="s2">"value_hash"</span><span class="p">:</span> <span class="s2">"60e8a5e97fe8b6064d0655c1eee16ff6dd650946"</span><span class="p">,</span> <span class="s2">"timestamp"</span><span class="p">:</span> <span class="s2">"2020-06-27 05:15:07.464279"</span><span class="p">,</span> <span class="s2">"args"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"0"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"arg_hash"</span><span class="p">:</span> <span class="s2">"16ce4470a4242d1c246d1c15a00487d73ce24efd"</span><span class="p">,</span> <span class="s2">"value_hash"</span><span class="p">:</span> <span class="s2">"b262cdb5130e8984ed3bb0dba8c83e56173ed702"</span><span class="p">,</span> <span class="s2">"upstream"</span><span class="p">:</span> <span class="p">[]}},</span> <span class="s2">"children"</span><span class="p">:</span> <span class="p">[]}</span>
<span class="p">{</span><span class="s2">"_version"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"_type"</span><span class="p">:</span> <span class="s2">"Job"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"94830f60-acaa-4b6b-9b22-f4572c64f85b"</span><span class="p">,</span> <span class="s2">"start_time"</span><span class="p">:</span> <span class="s2">"2020-06-26 22:21:32.266311"</span><span class="p">,</span> <span class="s2">"end_time"</span><span class="p">:</span> <span class="s2">"2020-06-26 22:21:32.283055"</span><span class="p">,</span> <span class="s2">"task_hash"</span><span class="p">:</span> <span class="s2">"d2b031e48e7f491a3d05a12f243f967517b25236"</span><span class="p">,</span> <span class="s2">"cached"</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="s2">"call_hash"</span><span class="p">:</span> <span class="s2">"1dc10a1cbf5696b00d1b6f3e9da2473ba088e033"</span><span class="p">,</span> <span class="s2">"parent_id"</span><span class="p">:</span> <span class="s2">"e0109842-8a69-4a4c-b2c6-9b97bfd35b43"</span><span class="p">,</span> <span class="s2">"children"</span><span class="p">:</span> <span class="p">[]}</span>
<span class="p">{</span><span class="s2">"_version"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"_type"</span><span class="p">:</span> <span class="s2">"Execution"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"6393500c-313c-43d7-87d4-d6feaeefaaab"</span><span class="p">,</span> <span class="s2">"args"</span><span class="p">:</span> <span class="s2">"[</span><span class="se">\"</span><span class="s2">/Users/rasmus/projects/redun.dev/.venv/bin/redun</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">run</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">make.py</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">make</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">--config</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">12</span><span class="se">\"</span><span class="s2">]"</span><span class="p">,</span> <span class="s2">"job_id"</span><span class="p">:</span> <span class="s2">"e060d21c-108e-4cfb-ad11-04e19ae4d460"</span><span class="p">}</span>
</pre></div>
</div>
<p>These JSON logs can be imported into another redun database using <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">import</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Export logs.</span>
<span class="n">redun</span> <span class="n">export</span> <span class="o">&gt;</span> <span class="n">logs</span><span class="o">.</span><span class="n">json</span>

<span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="n">logs</span><span class="o">.</span><span class="n">json</span>
<span class="c1"># 99</span>

<span class="c1"># Create a new redun database.</span>
<span class="n">redun</span> <span class="o">--</span><span class="n">config</span> <span class="n">redun2</span> <span class="n">init</span>

<span class="c1"># Second database should be empty initially.</span>
<span class="n">redun</span> <span class="o">--</span><span class="n">config</span> <span class="n">redun2</span> <span class="n">export</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
<span class="c1"># 0</span>

<span class="c1"># Import logs into second database.</span>
<span class="n">redun</span> <span class="o">--</span><span class="n">config</span> <span class="n">redun2</span> <span class="kn">import</span> <span class="o">&lt;</span> <span class="n">logs</span><span class="o">.</span><span class="n">json</span>

<span class="c1"># Second database is now populated.</span>
<span class="n">redun</span> <span class="o">--</span><span class="n">config</span> <span class="n">redun2</span> <span class="n">export</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
<span class="c1"># 99</span>
</pre></div>
</div>
<p>The import command is <a class="reference external" href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a>, so you can safely import log files that might contain records that already exist in the database, and redun will correctly only import the new records and avoid double insertions. Since records are immutable, there is no need to perform any updates or deletes, only inserts. Every record has a unique id that is either a hash or UUID, and therefore reconciling matching records is trivial.</p>
<p>redun can also efficiently sync new records using the <code class="docutils literal notranslate"><span class="pre">push</span></code> command, which works similar to <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Push to another repo.</span>
redun repo add other_repo redun2
redun push other_repo
</pre></div>
</div>
<p>This efficient sync is done by performing a graph walk of the redun database, similar to the <a class="reference external" href="https://matthew-brett.github.io/curious-git/git_push_algorithm.html">approach used by git</a>.</p>
<p>It is envisioned that the <code class="docutils literal notranslate"><span class="pre">push</span></code> command can be used in a data science workflow, where a data scientist could complete their analysis by pushing both their code provenance (version control) and their data provenance to central databases to share with their team.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Share your code provenance.</span>
git push origin main

<span class="c1"># Share your data provenance.</span>
redun push prod
</pre></div>
</div>
</section>
</section>
</section>
<section id="advanced-topics">
<h2>Advanced topics<a class="headerlink" href="#advanced-topics" title="Permalink to this headline">#</a></h2>
<section id="working-with-databases-and-apis">
<h3>Working with databases and APIs<a class="headerlink" href="#working-with-databases-and-apis" title="Permalink to this headline">#</a></h3>
<p>It’s common to use workflow engines to implement Extract Transform Load (ETL) pipelines which help move data between data stores such as databases, data lakes, and other services. Inevitably, we would need to work with ephemeral objects such as database connections and API clients that would have difficulties with caching and re-execution without providing special treatment. For example:</p>
<ul class="simple">
<li><p>Database connections or API clients might have internal state you don’t want serialized, such as secrets or overly specific configuration information (IP addresses, port numbers).</p></li>
<li><p>Connections would also have state such as socket file descriptors that won’t be valid when deserialized later on.</p></li>
<li><p>With files, we were able to double check if their current state was consistent with our cache by hashing them. With a database or API, it’s typically not feasible to hash a whole database. Is there something else we could do?</p></li>
<li><p>The redun cache contains cached results from all previous runs. Conveniently, that allows for fast reverting to old results if code or input data is changed back to old state. However, for a stateful system like a database, we likely can’t just re-execute arbitrary tasks in any order. Similar to database migration frameworks (South, Alembic, etc), we may need to rollback past tasks before applying new ones.</p></li>
</ul>
<p>redun provides solutions to several of these challenges using a concept called Handles.</p>
</section>
<section id="handles-for-ephemeral-and-stateful-values">
<h3>Handles for ephemeral and stateful values<a class="headerlink" href="#handles-for-ephemeral-and-stateful-values" title="Permalink to this headline">#</a></h3>
<p>We’ll introduce the features of Handles in several steps. The first feature that Handles provides is control over the data used for serialization and a mechanism for recreating ephemeral state after deserialization. Let’s say we wanted to pass a database connection between tasks in a safe way. We could use a Handle class to do the following:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">task</span><span class="p">,</span> <span class="n">Handle</span>

<span class="k">class</span> <span class="nc">DbHandle</span><span class="p">(</span><span class="n">Handle</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">db_file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span> <span class="o">=</span> <span class="n">db_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">'select * from my_table'</span><span class="p">)</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># result = transform data in some way...</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">'insert into another_table values(?, ?, ?)'</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Two databases we want to move data between</span>
    <span class="n">src_conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">'src_conn'</span><span class="p">,</span> <span class="s1">'src_data.db'</span><span class="p">)</span>
    <span class="n">dest_conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">'dest_conn'</span><span class="p">,</span> <span class="s1">'dest_data.db'</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">src_conn</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">dest_conn2</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_conn</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dest_conn2</span>
</pre></div>
</div>
<p>First, we use the <code class="docutils literal notranslate"><span class="pre">DbHandle</span></code> class to wrap a sqlite database connection. When Handles are serialized, only the arguments to their constructor are serialized. Therefore, you can define as much internal state as you wish for a Handle and it will not get caught up in the cache. redun’s default serialization is Python’s pickle framework. pickle uses the <code class="docutils literal notranslate"><span class="pre">__new__()</span></code> constructor and <code class="docutils literal notranslate"><span class="pre">__setstate__</span></code> (or <code class="docutils literal notranslate"><span class="pre">__dict__</span></code>) to directly set the state of an object, thus avoiding calling the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> initializer. Handles modify this behavior in order to execute <code class="docutils literal notranslate"><span class="pre">__init__</span></code> even when deserializing. Therefore, we can use the constructor to reestablish ephemeral state such as the database connection.</p>
<p>Since Handles are often used to wrap another object, such as a connection, Handles provide a convenient mechanism for reducing boiler plate code. If a Handle defines a <code class="docutils literal notranslate"><span class="pre">self.instance</span></code> attribute, all attribute access to the Handle is automatically proxied to the <code class="docutils literal notranslate"><span class="pre">self.instance</span></code>. Above the <code class="docutils literal notranslate"><span class="pre">conn.execute()</span></code> and <code class="docutils literal notranslate"><span class="pre">conn.executemany()</span></code> calls make use of the attribute proxy.</p>
<section id="state-tracking">
<h4>State tracking<a class="headerlink" href="#state-tracking" title="Permalink to this headline">#</a></h4>
<p>Now let’s take a closer look at the <code class="docutils literal notranslate"><span class="pre">load()</span></code> task. It uses a handle, <code class="docutils literal notranslate"><span class="pre">dest_conn</span></code>, as an input and output in order to perform a write. Ideally, we would like to represent that <code class="docutils literal notranslate"><span class="pre">dest_conn</span></code> is updated by the <code class="docutils literal notranslate"><span class="pre">load</span></code> task, so that we can correctly determine which tasks need to be re-executed when input data or code changes.</p>
<p>As we stated before, hashing an entire database just to represent the database state is often not feasible, either because there is too much data to rehash frequently, or the database state contains too much ancillary data to hash consistently. As an alternative to hashing the whole database, we could just hash the sequence of operations (i.e. Tasks) we have applied to database Handle. This is the strategy redun takes.</p>
<p>Specifically, as a handle passes into or out of a Task, the redun scheduler, duplicates the Handle, and incorporates into its hash information specific to the task call, such as the hash of the corresponding call node. Therefore, in the example above, if we look at these specific lines:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">conn_i</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">'insert into another_table values(?, ?, ?)'</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn_i</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># SNIP...</span>
    <span class="n">dest_conn2</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_conn</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
    <span class="c1"># SNIP ...</span>
</pre></div>
</div>
<p>the handles <code class="docutils literal notranslate"><span class="pre">dest_conn</span></code>, <code class="docutils literal notranslate"><span class="pre">conn_i</span></code>, and <code class="docutils literal notranslate"><span class="pre">dest_conn2</span></code> are all distinct and have their own hashes. redun also records the lineage of such handles into a Handle Graph which represents the state transitions the handle has gone through:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dest_conn</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_i</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn2</span><span class="o">*</span>
</pre></div>
</div>
<p>redun also records whether each handle state is currently valid or not, which we indicate above using <code class="docutils literal notranslate"><span class="pre">*</span></code> for valid handles. When re-executing a workflow, if a previously cached handle state is still valid we can safely fast forward through the corresponding task.</p>
<p>Now, lets consider what happens if we added an additional load step and re-executed this workflow:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">conn_i</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># Write data into conn_i...</span>
    <span class="k">return</span> <span class="n">conn_i</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">load2</span><span class="p">(</span><span class="n">conn_ii</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># Write date into conn_ii...</span>
    <span class="k">return</span> <span class="n">conn_ii</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Two databases we want to move data between</span>
    <span class="n">src_conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">'src_conn'</span><span class="p">,</span> <span class="s1">'src_data.db'</span><span class="p">)</span>
    <span class="n">dest_conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">'dest_conn'</span><span class="p">,</span> <span class="s1">'dest_data.db'</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">src_conn</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data3</span> <span class="o">=</span> <span class="n">transform2</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">dest_conn2</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">dest_conn</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
    <span class="n">dest_conn3</span> <span class="o">=</span> <span class="n">load2</span><span class="p">(</span><span class="n">dest_conn2</span><span class="p">,</span> <span class="n">data3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dest_conn3</span>
</pre></div>
</div>
<p>redun would notice that it can forward through <code class="docutils literal notranslate"><span class="pre">extract</span></code>, <code class="docutils literal notranslate"><span class="pre">transform</span></code>, and <code class="docutils literal notranslate"><span class="pre">load</span></code>, and would only execute <code class="docutils literal notranslate"><span class="pre">transform2</span></code>, and <code class="docutils literal notranslate"><span class="pre">load2</span></code>. The Handle Graph would be updated with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dest_conn</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_i</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn2</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_ii</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn3</span><span class="o">*</span>
</pre></div>
</div>
<p>Now consider what happens if we decided to change the code of task <code class="docutils literal notranslate"><span class="pre">load2()</span></code>. redun would fast forward through much of the workflow but would re-execute <code class="docutils literal notranslate"><span class="pre">load2()</span></code>. In doing so it would branch the Handle Graph, since <code class="docutils literal notranslate"><span class="pre">load2()</span></code> would contribute a different call node hash to the <code class="docutils literal notranslate"><span class="pre">dest_conn3</span></code>. Let’s consider this new Handle <code class="docutils literal notranslate"><span class="pre">dest_conn3b</span></code>, and the Handle Graph would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dest_conn</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_i</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn2</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_ii</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">dest_conn3</span>
                                                  \
                                                   \<span class="o">--&gt;</span> <span class="n">dest_conn3b</span><span class="o">*</span>
</pre></div>
</div>
<p>The old handle state <code class="docutils literal notranslate"><span class="pre">dest_conn3</span></code> is marked as invalid. What’s important about this bookkeeping is that if we revert the change to <code class="docutils literal notranslate"><span class="pre">load2()</span></code>, it is not appropriate to just fast revert to dest_conn3. We must re-execute <code class="docutils literal notranslate"><span class="pre">load2()</span></code> again to update the database to be at state <code class="docutils literal notranslate"><span class="pre">dest_conn3</span></code> (instead of <code class="docutils literal notranslate"><span class="pre">dest_conn3b</span></code>).</p>
</section>
<section id="more-advance-handle-uses">
<h4>More advance Handle uses<a class="headerlink" href="#more-advance-handle-uses" title="Permalink to this headline">#</a></h4>
<p><em>This is currently explained very briefly</em></p>
<p>Handles can be forked into instances that can be processed in parallel (parallel loading into a database). Forking might also be done to denote that there is no dependency between the tasks and limit the scope of rollbacks (i.e. Handle invalidation).</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">redun</span> <span class="kn">import</span> <span class="n">merge_handles</span>

<span class="c1"># SNIP ...</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">DbHandle</span><span class="p">(</span><span class="s1">'conn'</span><span class="p">,</span> <span class="s1">'data.db'</span><span class="p">)</span>
    <span class="n">conn2a</span> <span class="o">=</span> <span class="n">load_a</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">conn2b</span> <span class="o">=</span> <span class="n">load_b</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">conn3</span> <span class="o">=</span> <span class="n">merge_handles</span><span class="p">([</span><span class="n">conn2a</span><span class="p">,</span> <span class="n">conn2b</span><span class="p">])</span>
    <span class="n">conn4</span> <span class="o">=</span> <span class="n">load_c</span><span class="p">(</span><span class="n">conn3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn4</span>
</pre></div>
</div>
<p>Handles can also be merged to denote that the previous parallel steps must complete before continuing to the next step. The Handle Graph for the above code would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_i</span><span class="o">*</span> <span class="o">---&gt;</span> <span class="n">conn2a</span><span class="o">*</span> <span class="o">----&gt;</span> <span class="n">conn3</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn_iii</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn4</span><span class="o">*</span>
    \                            <span class="o">/</span>
     \<span class="o">--&gt;</span> <span class="n">conn_ii</span><span class="o">*</span> <span class="o">--&gt;</span> <span class="n">conn2b</span><span class="o">*</span> <span class="o">-/</span>
</pre></div>
</div>
<p>Using the above Handle Graph, redun can determine that updating the code for <code class="docutils literal notranslate"><span class="pre">load_b()</span></code> should trigger re-execution for <code class="docutils literal notranslate"><span class="pre">load_b()</span></code> and <code class="docutils literal notranslate"><span class="pre">load_c()</span></code>, but not <code class="docutils literal notranslate"><span class="pre">load_a()</span></code>.</p>
</section>
</section>
<section id="task-wrapping">
<h3>Task wrapping<a class="headerlink" href="#task-wrapping" title="Permalink to this headline">#</a></h3>
<p>We provide a mechanism for wrapping tasks, which is a powerful mechanism for altering
the run-time behavior of a task. Conceptually inspired by <code class="docutils literal notranslate"><span class="pre">@functools.wraps</span></code>, which makes it easier
to create decorators that enclose functions. As a motivating example, consider a task that needs
to operate in parallel processes on the worker that executes the task. We can partition the
implementation into a generic wrapper that launches parallel processes and an inner task
that operates within that context.</p>
<p>Specifically, this helps us create a decorator that accepts a task and wraps it. The task
passed in is moved into an inner namespace, hiding it. Then a new task is created from the
wrapper implementation that assumes its identity; the wrapper is given access to both the run-time
arguments and the hidden task definition. Since <code class="docutils literal notranslate"><span class="pre">Tasks</span></code> may be wrapped repeatedly,
the hiding step is recursive.</p>
<p>A simple usage example is a new decorator <code class="docutils literal notranslate"><span class="pre">@doubled_task</span></code>, which simply runs the original
task and multiplies by two.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">doubled_task</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Func</span><span class="p">],</span> <span class="n">Task</span><span class="p">[</span><span class="n">Func</span><span class="p">]]:</span>

    <span class="c1"># The name of this inner function is used to create the nested namespace,</span>
    <span class="c1"># so idiomatically, use the same name as the decorator with a leading underscore.</span>
    <span class="nd">@wraps_task</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_doubled_task</span><span class="p">(</span><span class="n">inner_task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Task</span><span class="p">[</span><span class="n">Func</span><span class="p">]],</span> <span class="n">Func</span><span class="p">]:</span>

        <span class="c1"># The behavior when the task is run. Note we have both the task and the</span>
        <span class="c1"># runtime args.</span>
        <span class="k">def</span> <span class="nf">do_doubling</span><span class="p">(</span><span class="o">*</span><span class="n">task_args</span><span class="p">,</span> <span class="o">**</span><span class="n">task_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">inner_task</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">task_args</span><span class="p">,</span> <span class="o">**</span><span class="n">task_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">do_doubling</span>
    <span class="k">return</span> <span class="n">_doubled_task</span>

<span class="c1"># Create the task implicitly</span>
<span class="nd">@doubled_task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">value_task</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span>

<span class="c1"># Or we can do it manually</span>
<span class="nd">@doubled_task</span><span class="p">()</span>
<span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"renamed"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">value_task2</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span>

<span class="c1"># We can keep going</span>
<span class="nd">@doubled_task</span><span class="p">()</span>
<span class="nd">@doubled_task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">value_task3</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span>
</pre></div>
</div>
<p>This mechanism might be used to alter the runtime behavior, such as by retrying the task
if it fails or running it in parallel. We suggest that users prefer other approaches for
defining their tasks, and only use this technique when access to the <code class="docutils literal notranslate"><span class="pre">Task</span></code> object itself is
needed.</p>
<p>There is an additional subtlety if the wrapper itself accepts arguments. These must be passed
along to the wrapper so they are visible to the scheduler. Needing to do this manually is
the cost of the extra powers we have.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># An example of arguments consumed by the wrapper</span>
<span class="k">def</span> <span class="nf">wrapper_with_args</span><span class="p">(</span><span class="n">wrapper_arg</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Func</span><span class="p">],</span> <span class="n">Task</span><span class="p">[</span><span class="n">Func</span><span class="p">]]:</span>

    <span class="c1"># WARNING: Be sure to pass the extra data for hashing so it participates in the cache </span>
    <span class="c1"># evaluation</span>
    <span class="nd">@wraps_task</span><span class="p">(</span><span class="n">wrapper_extra_hash_data</span><span class="o">=</span><span class="p">[</span><span class="n">wrapper_arg</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_wrapper_with_args</span><span class="p">(</span><span class="n">inner_task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Task</span><span class="p">[</span><span class="n">Func</span><span class="p">]],</span> <span class="n">Func</span><span class="p">]:</span>

        <span class="k">def</span> <span class="nf">do_wrapper_with_args</span><span class="p">(</span><span class="o">*</span><span class="n">task_args</span><span class="p">,</span> <span class="o">**</span><span class="n">task_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapper_arg</span> <span class="o">*</span> <span class="n">inner_task</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">task_args</span><span class="p">,</span> <span class="o">**</span><span class="n">task_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">do_wrapper_with_args</span>
    <span class="k">return</span> <span class="n">_wrapper_with_args</span>
</pre></div>
</div>
</section>
</section>
<section id="implementation-notes">
<h2>Implementation notes<a class="headerlink" href="#implementation-notes" title="Permalink to this headline">#</a></h2>
<section id="evaluation-process">
<h3>Evaluation process<a class="headerlink" href="#evaluation-process" title="Permalink to this headline">#</a></h3>
<p>redun’s evaluation process can be summarized with the following pseudo code:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Top-level evaluation of an expression.</span>
<span class="n">evaluate</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
   <span class="sd">"""</span>
<span class="sd">   Evaluate an expression.</span>
<span class="sd">   """</span>
   <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">TaskExpression</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">evaluate_task</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
   <span class="k">elif</span> <span class="n">expr</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">SimpleExpression</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">eval_simple_expression</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
   <span class="k">elif</span> <span class="n">expr</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">nested</span> <span class="n">value</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">map_nested_value</span><span class="p">(</span><span class="n">evaluate</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="c1"># expr is a concrete value, return it as is.</span>
       <span class="k">return</span> <span class="n">expr</span>

<span class="k">def</span> <span class="nf">evaluate_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Evaluate a Task.</span>
<span class="sd">    """</span>
    <span class="c1"># Evaluate arguments.</span>
    <span class="n">eval_args</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">preprocessed_args</span> <span class="o">=</span> <span class="n">preprocess_args</span><span class="p">(</span><span class="n">eval_args</span><span class="p">)</span>

    <span class="c1"># Use cache to fast-forward if possible.</span>
    <span class="n">args_hash</span> <span class="o">=</span> <span class="n">hash_arguments</span><span class="p">(</span><span class="n">preprocess_args</span><span class="p">)</span>
    <span class="n">eval_hash</span> <span class="o">=</span> <span class="n">hash_eval</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">args_hash</span><span class="p">)</span>
    <span class="n">postprocessed_result</span> <span class="o">=</span> <span class="n">get_cache</span><span class="p">(</span><span class="n">eval_hash</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">args_hash</span><span class="p">,</span> <span class="n">check_valid</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">check_valid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">postprocessed_result</span> <span class="ow">is</span> <span class="n">Nothing</span><span class="p">:</span>
        <span class="n">perform_rollbacks</span><span class="p">(</span><span class="n">preprocess_args</span><span class="p">)</span>

        <span class="c1"># Evaluate task.</span>
        <span class="n">eval_result</span> <span class="o">=</span> <span class="n">executor_submit</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">preprocessed_args</span><span class="p">)</span>
        <span class="n">postprocessed_result</span> <span class="o">=</span> <span class="n">postprocess_result</span><span class="p">(</span><span class="n">eval_result</span><span class="p">)</span>
        <span class="n">set_cache</span><span class="p">(</span><span class="n">eval_hash</span><span class="p">,</span> <span class="n">postprocessed_result</span><span class="p">)</span>

    <span class="c1"># Evaluate result.</span>
    <span class="c1"># This is needed because lazy evaluation will return an expression</span>
    <span class="c1"># that needs further evaluation.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">postprocessed_result</span><span class="p">)</span>

    <span class="n">child_call_hashes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">call_node</span><span class="o">.</span><span class="n">call_hash</span>
        <span class="k">for</span> <span class="n">call_node</span> <span class="ow">in</span> <span class="n">CallNodes</span> <span class="n">created</span> <span class="ow">in</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">postprocess_result</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">call_node</span> <span class="o">=</span> <span class="n">record_call_node</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span>
        <span class="n">eval_args</span><span class="p">,</span>
        <span class="n">result</span><span class="p">,</span>
        <span class="n">child_call_hashes</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">get_cache</span><span class="p">(</span><span class="n">eval_hash</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">,</span> <span class="n">args_hash</span><span class="p">,</span> <span class="n">check_valid</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Consult key-value store for cached results.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">check_valid</span> <span class="o">==</span> <span class="s1">'full'</span><span class="p">:</span>
        <span class="n">cache_result</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">get_eval_cache</span><span class="p">(</span><span class="n">eval_hash</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">check_valid</span> <span class="o">==</span> <span class="s1">'shallow'</span><span class="p">:</span>
        <span class="n">cache_result</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">get_cache</span><span class="p">(</span><span class="n">task_hash</span><span class="p">,</span> <span class="n">args_hash</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">is_valid_value</span><span class="p">(</span><span class="n">cache_result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cache_result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Nothing</span>
</pre></div>
</div>
</section>
<section id="content-addressable-hashing-summary">
<h3>Content addressable hashing summary<a class="headerlink" href="#content-addressable-hashing-summary" title="Permalink to this headline">#</a></h3>
<p>redun uses hashing to create deterministic ids for many records in the redun data model. The design of this hashing scheme has several properties:</p>
<ul class="simple">
<li><p>Every hash is unique across all records.</p>
<ul>
<li><p>While a cryptographically secure hash function can be assumed to not produce hash collisions, we can still have collisions on pre-image data if we are not careful. For example, a CallNode could have the same hash as a file that contains a pickle of a CallNode, if the hashing schema is not carefully designed.</p></li>
<li><p>To achieve this property, every pre-image is prefixed with a record type, such as ‘Task’, ‘CallNode’, etc.</p></li>
<li><p>It is also easy to have pre-image collisions if arguments to a hash are not well escaped (e.g. if tab is used as an argument delimiter, you need to always escape tabs in string arguments). We solve this systematically by defining a consistent way of efficiently serializing structures using bittorrent encoding format (bencode).</p></li>
</ul>
</li>
<li><p>When one parental record refers to a child record, the child record’s hash is included in the parent’s hash.</p>
<ul>
<li><p>This forms a <a class="reference external" href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle Tree</a> that gives unique hashes to nodes in the resulting DAG.</p></li>
</ul>
</li>
<li><p>Hashes are represented by hex strings instead of bytes to aide easy debugging and display.</p>
<ul>
<li><p>If greater hashing efficiency is desired, hashes could be kept in their binary byte representation.</p></li>
</ul>
</li>
<li><p>Hashes are truncated to 40 hex bytes for easier display.</p>
<ul>
<li><p>If the reduced hash space is a concern this truncation could be removed.</p></li>
</ul>
</li>
</ul>
<p>Here, is a summary of how they are computed and related to each other:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic functions.</span>
<span class="n">blob_hash</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">sha512</span><span class="p">(</span><span class="nb">bytes</span><span class="p">))[:</span><span class="mi">40</span><span class="p">]</span>
<span class="n">hash_struct</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span> <span class="o">=</span> <span class="n">blob_hash</span><span class="p">(</span><span class="n">bencode</span><span class="p">(</span><span class="n">struct</span><span class="p">))</span>

<span class="n">value_hash</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'Value'</span><span class="p">,</span> <span class="n">blob_hash</span><span class="p">(</span><span class="n">serialize</span><span class="p">(</span><span class="n">value</span><span class="p">))])</span>
<span class="c1"># alt: value_hash(value) = blob_hash(serialize(value))</span>

<span class="n">task_hash</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'Task'</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">'version'</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">version</span><span class="p">])</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">version</span> <span class="n">defined</span><span class="p">,</span>
  <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'Task'</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">'source'</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">source</span><span class="p">])</span> <span class="n">otherwise</span>
<span class="p">}</span>

<span class="n">args_hash</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">=</span> <span class="n">hash_struct</span><span class="p">([</span>
    <span class="s1">'TaskArguments'</span><span class="p">,</span>
    <span class="p">[</span><span class="n">value_hash</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span>
    <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value_hash</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
<span class="p">])</span>

<span class="n">call_hash</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="o">=</span> <span class="n">hash_struct</span><span class="p">([</span>
    <span class="s1">'CallNode'</span><span class="p">,</span>
    <span class="n">task_hash</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">task</span><span class="p">),</span>
    <span class="n">args_hash</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span>
    <span class="n">value_hash</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">),</span>  <span class="c1"># result_hash</span>
    <span class="p">[</span>
       <span class="n">call_hash</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">child_jobs</span>
    <span class="p">]</span>  <span class="c1"># child_call_hashes</span>
<span class="p">])</span>

<span class="n">arg_hash</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span> <span class="o">=</span> <span class="n">hash_struct</span><span class="p">([</span>
    <span class="s1">'Argument'</span><span class="p">,</span> <span class="n">call_hash</span><span class="p">(</span><span class="n">job</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value_hash</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">eval_hash</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="o">=</span> <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'Eval'</span><span class="p">,</span> <span class="n">task_hash</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">task</span><span class="p">),</span> <span class="n">args_hash</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)])</span>

<span class="n">file_hash</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'File'</span><span class="p">,</span> <span class="s1">'local'</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">mtime</span><span class="p">)])</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">proto</span> <span class="o">==</span> <span class="s1">'local'</span><span class="p">,</span>
    <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'File'</span><span class="p">,</span> <span class="s1">'s3'</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">etag</span><span class="p">])</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">proto</span> <span class="o">==</span><span class="s1">'s3'</span>
<span class="p">}</span>

<span class="n">fileset_hash</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span> <span class="o">=</span> <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'FileSet'</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">hash</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">fileset</span><span class="p">))</span>

<span class="n">dir_hash</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span> <span class="o">=</span> <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'Dir'</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">hash</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">fileset</span><span class="p">))</span>

<span class="n">handle_hash</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'Handle'</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">'call_hash'</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">call_hash</span><span class="p">])</span> <span class="k">if</span> <span class="n">handle</span><span class="o">.</span><span class="n">call_hash</span><span class="p">,</span>
    <span class="n">hash_struct</span><span class="p">([</span><span class="s1">'Handle'</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">'init'</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">kwargs</span><span class="p">])</span> <span class="n">otherwise</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="connections-to-functional-programming">
<h3>Connections to functional programming<a class="headerlink" href="#connections-to-functional-programming" title="Permalink to this headline">#</a></h3>
<p>redun’s use of task decorators and lazy-evaluation can be thought of as a <a class="reference external" href="https://en.wikipedia.org/wiki/Monad_(functional_programming)">monad</a>. The redun monad consists of three components:</p>
<ul class="simple">
<li><p>A type constructor <code class="docutils literal notranslate"><span class="pre">M</span></code>:</p>
<ul>
<li><p>redun uses <code class="docutils literal notranslate"><span class="pre">Expression</span></code> to wrap user values (type <code class="docutils literal notranslate"><span class="pre">a</span></code>).</p></li>
</ul>
</li>
<li><p>A type converter <code class="docutils literal notranslate"><span class="pre">unit</span> <span class="pre">::</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">a</span></code>:</p>
<ul>
<li><p>redun uses <code class="docutils literal notranslate"><span class="pre">ExpressionValue(a)</span></code> to lift a user value into the monad. This is conceptually done automatically for the user.</p></li>
</ul>
</li>
<li><p>A combinator <code class="docutils literal notranslate"><span class="pre">bind</span> <span class="pre">::</span> <span class="pre">M</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">(a</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">b)</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">b</span></code>:</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">@task()</span></code> decorator plays the role of <code class="docutils literal notranslate"><span class="pre">bind</span></code> although with the arguments reversed.</p></li>
</ul>
</li>
</ul>
<p>Let’s look at the following example:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">task1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>

<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">task2</span><span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">task1</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The undecorated function <code class="docutils literal notranslate"><span class="pre">task2</span></code> is a monadic function and has type <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">b</span></code>, where <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> are <code class="docutils literal notranslate"><span class="pre">int</span></code>. The return type is <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">b</span></code> because <code class="docutils literal notranslate"><span class="pre">task(y</span> <span class="pre">+</span> <span class="pre">1)</span></code> will return an <code class="docutils literal notranslate"><span class="pre">Expression</span></code> (<code class="docutils literal notranslate"><span class="pre">M</span></code>) wrapping an int (<code class="docutils literal notranslate"><span class="pre">b</span></code>).</p></li>
<li><p>We can think of decorator <code class="docutils literal notranslate"><span class="pre">@task</span></code> as performing currying.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">task2</span></code> has type <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">b</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">task(task2)</span></code> transforms the function to have type <code class="docutils literal notranslate"><span class="pre">M</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">b</span></code>, since decorated tasks can accept <code class="docutils literal notranslate"><span class="pre">Expressions</span></code> as arguments. For arguments that are concrete user values (type <code class="docutils literal notranslate"><span class="pre">a</span></code>), redun automatically wraps the arguments with <code class="docutils literal notranslate"><span class="pre">ValueExpression</span></code>, at least conceptually.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">task(task2)(ValueExpression(10))</span></code> is viewed as currying, we could write this as <code class="docutils literal notranslate"><span class="pre">task(task2,</span> <span class="pre">ValueExpression(10))</span></code> and <code class="docutils literal notranslate"><span class="pre">task</span></code> has type <code class="docutils literal notranslate"><span class="pre">(a</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">b)</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">M</span> <span class="pre">b</span></code>. This is very close to <code class="docutils literal notranslate"><span class="pre">bind</span></code> except with arguments reversed.</p></li>
</ul>
</li>
</ul>
<p>By using monads to wrap the computation, redun can analyze the dataflow between tasks and perform proper parallelization and scheduling transparently. By design, redun tries to leverage the benefits of monads and functional programming concepts, but in a style familiar to Python developers.</p>
<p>This section from the <a class="reference external" href="https://en.wikipedia.org/wiki/Monad_(functional_programming)">monad Wikipedia page</a> provides a good summary of why the monad is a natural fit for defining a workflow:</p>
<blockquote>
<div><p>The value of the monad pattern goes beyond merely condensing code and providing a link to mathematical reasoning. Whatever language or default programming paradigm a developer uses, following the monad pattern brings many of the benefits of purely functional programming. By reifying a specific kind of computation, a monad not only encapsulates the tedious details of that computational pattern, but it does so in a declarative way, improving the code’s clarity. As monadic values explicitly represent not only computed values, but computed effects, a monadic expression can be substituted with its value in referentially transparent positions, much like pure expressions can be, allowing for many techniques and optimizations based on rewriting.[5]</p>
</div></blockquote>
<p>In our use, “reifying” means wrapping the computation into an expression tree that our scheduler can analyze for deciding which tasks can be executed safely in parallel, which tasks can be skipped due to caching, etc. Generating the expression tree is what makes redun <em>declarative</em>, even though we do execute imperative code to generate the expression tree.</p>
</section>
<section id="redun-a-language-within">
<h3>redun: a language within<a class="headerlink" href="#redun-a-language-within" title="Permalink to this headline">#</a></h3>
<p>redun can be thought of as implementing a asynchronous functional programming language within Python, which is an imperative multi-paradigm language, a general pattern called <a class="reference external" href="https://en.wikipedia.org/wiki/Metaprogramming">metaprogramming</a>. This strategy for implementing a workflow engine allows us to use a very popular programming language, Python (used in data science, ML, web development, ETLs), but adapt it to have language features amenable to distributed computing. The following features map between Python and redun-the-language:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Task</span></code>s are the functions of redun.</p></li>
<li><p>Tasks are <a class="reference external" href="https://en.wikipedia.org/wiki/First-class_function">first-class values</a> in redun and therefore can be passed as arguments and returned as results from redun functions.</p></li>
<li><p>Task input arguments and outputs are the values of redun.</p>
<ul>
<li><p>In fact, the base class for classes like <code class="docutils literal notranslate"><span class="pre">File</span></code>, <code class="docutils literal notranslate"><span class="pre">Handle</span></code>, and <code class="docutils literal notranslate"><span class="pre">Task</span></code> is <code class="docutils literal notranslate"><span class="pre">Value</span></code>.</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Scheduler</span></code> is the interpreter and runtime of redun.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Expression</span></code> implements expressions in the redun language. The <code class="docutils literal notranslate"><span class="pre">Scheduler</span></code> recursively evaluates <code class="docutils literal notranslate"><span class="pre">Expression</span></code>s into concrete values.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">TaskRegistry</span></code> and <code class="docutils literal notranslate"><span class="pre">TypeRegistry</span></code> are the environment (described in <a class="reference external" href="https://en.wikipedia.org/wiki/Scope_(computer_science)#Overview">Scope</a>) for redun.</p></li>
<li><p>Plain Python functions that take <code class="docutils literal notranslate"><span class="pre">Expression</span></code>s are like <a class="reference external" href="https://en.wikipedia.org/wiki/Macro_(computer_science)#Syntactic_macros">macros</a> since they are evaluated at “compile-time” (i.e. workflow construction-time).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scheduler_task</span></code>s are the equivalent of <a class="reference external" href="https://en.wikipedia.org/wiki/Fexpr">fexpr</a> and can be used to implement <a class="reference external" href="https://groups.csail.mit.edu/mac/ftpdir/scheme-7.4/doc-html/scheme_3.html">special forms</a> in redun.</p>
<ul>
<li><p>One could implement if-expressions (<code class="docutils literal notranslate"><span class="pre">cond</span></code>), try-except (<code class="docutils literal notranslate"><span class="pre">catch</span></code>), and <code class="docutils literal notranslate"><span class="pre">seq</span></code>.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">PartialTask</span></code> allows the creation of closures for redun, since they do not evaluate their arguments until all other arguments are supplied.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">PartialTask</span></code>s can be used to implement <code class="docutils literal notranslate"><span class="pre">delay</span></code> and <code class="docutils literal notranslate"><span class="pre">force</span></code>.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="influences">
<h2>Influences<a class="headerlink" href="#influences" title="Permalink to this headline">#</a></h2>
<p>Development of redun has been inspired by many projects. Here is a brief review of our understanding of how redun’s ideas relate to similar concepts seen elsewhere.</p>
<ul class="simple">
<li><p>Bioinformatic workflow languages: <a class="reference external" href="https://github.com/openwdl/wdl">WDL</a>, <a class="reference external" href="https://www.commonwl.org/">CWL</a>, <a class="reference external" href="https://www.nextflow.io/">Nextflow</a>, <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/">Snakemake</a>, <a class="reference external" href="https://github.com/grailbio/reflow">Reflow</a></p>
<ul>
<li><p>Workflow languages such as these give special treatment to file and code change reactivity, which is especially helpful in scientific workflows that typically go through quick interactive development. redun’s <code class="docutils literal notranslate"><span class="pre">File</span></code> and task hashing were inspired by these languages.</p></li>
<li><p>Bioinformatic workflow languages are most commonly used to wrap unix programs that expect their input and output files to be local. Accordingly, these languages typically provide a specific syntax to help copy files from cloud storage to local disk and back, a process sometimes called staging or localization. This behavior inspired redun’s <code class="docutils literal notranslate"><span class="pre">File(remote_path).stage(local_path)</span></code> syntax. The need to make frequent calls to unix programs inspired the <code class="docutils literal notranslate"><span class="pre">script()</span></code> task.</p></li>
<li><p>They also all define a Domain Specific Language (DSL) in order to enforce pure functions or provide dedicated syntax for task dependency. redun differs by relying on a host language, Python. Using Python makes it difficult to enforce some of the same constraints (e.g. function purity), but it does allow redun workflows to more easily integrate with the whole world of Python data science libraries (e.g. Pandas, NumPy, pytorch, rdkit, sqlalchemy, etc) without layers of wrapping (e.g. driver scripts, data serializing/deserializing, Docker images).</p></li>
</ul>
</li>
<li><p>Data engineering workflow languages: <a class="reference external" href="https://airflow.apache.org/">Airflow</a>, <a class="reference external" href="https://github.com/spotify/luigi">Luigi</a>, <a class="reference external" href="https://www.prefect.io/">Prefect</a></p>
<ul>
<li><p>These workflow languages have had a more general focus beyond interacting with files. They are often used for ETLs (extract-transform-load) where data is exchanged with databases or web services. redun does not assume all dataflow is through files and so can used for interacting with databases and APIs as well.</p></li>
<li><p>Airflow v2, Prefect, and <a class="reference external" href="https://docs.dask.org/en/latest/delayed.html">Dask delayed</a> have adopted defining tasks as decorated Python functions, which when invoked return a Promise / Future / Delayed that can be passed as an argument to another task call. The workflow engine can then inspect the presence of these lazy objects in task call arguments in order to infer the edges of the workflow DAG. This allows very natural looking workflow definitions. redun uses the same approach but returns Expressions instead, which differ from other lazy values in several ways. First, the evaluation of an Expression can change depending on what larger Expression it belongs to, such <code class="docutils literal notranslate"><span class="pre">cond()</span></code> or <code class="docutils literal notranslate"><span class="pre">catch()</span></code>. Second, Expressions are free to return more Expressions for evaluation. Third, redun will evaluate Expressions inside of Nested Values (list, dict, set, tuple, NamedTuple) by default.</p></li>
</ul>
</li>
<li><p>Expression hashing: <a class="reference external" href="https://www.unisonweb.org/">Unison</a>, <a class="reference external" href="https://github.com/StanfordSNR/gg">gg</a></p>
<ul>
<li><p>In Unison, every expression is hashable and the hash can be used as a cache key for replaying reductions / evaluations from a cache. This is similar to how redun represents a workflow as a graph of Expressions, each of which is hashed in order to consult a central cache (Value Store).</p></li>
<li><p>In gg, a workflow is defined as a graph of thunks (redun’s TaskExpression) which is evaluated using graph reduction. Each reduction is performed on a remote execution system such as AWS Lambda. redun is very similar, but also allows evaluating each Expression on a different Executor (e.g. threads, processes, Batch jobs, Spark jobs, etc).</p></li>
</ul>
</li>
<li><p>Functional programming languages: <a class="reference external" href="https://www.haskell.org/">Haskell</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a></p>
<ul>
<li><p>redun’s Scheduler can be seen as an interpreter for a <a class="reference internal" href="#redun-a-language-within"><span class="std std-doc">functional programming language</span></a>. Many of the builtin tasks take their name from similar functions in Haskell and Lisp: <code class="docutils literal notranslate"><span class="pre">map_</span></code>, <code class="docutils literal notranslate"><span class="pre">flat_map</span></code>, <code class="docutils literal notranslate"><span class="pre">seq</span></code>, <code class="docutils literal notranslate"><span class="pre">catch</span></code>, <code class="docutils literal notranslate"><span class="pre">cond</span></code>, <code class="docutils literal notranslate"><span class="pre">delay</span></code>, <code class="docutils literal notranslate"><span class="pre">force</span></code>, <code class="docutils literal notranslate"><span class="pre">@scheduler_task</span></code> (a.k.a. <a class="reference external" href="https://www.cs.cmu.edu/Groups/AI/html/cltl/clm/node59.html">special forms</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/Fexpr">fexpr</a>).</p></li>
<li><p>redun is like Lisp in that higher level constructs like <code class="docutils literal notranslate"><span class="pre">catch</span></code> and <code class="docutils literal notranslate"><span class="pre">cond</span></code> are defined using lower-level features like <code class="docutils literal notranslate"><span class="pre">@scheduler_task</span></code>. This allows users to extend the workflow language similar to extending Lisp using macros.</p></li>
</ul>
</li>
<li><p>Build systems: <a class="reference external" href="https://redo.readthedocs.io/en/latest/">redo</a>, <a class="reference external" href="https://dl.acm.org/doi/10.1145/3236774">Build systems a la Carte</a></p>
<ul>
<li><p>redo shows how the build steps (“tasks” in redun’s terminology) can be arbitrary code that does not require static analysis of its dependencies (child task calls). Instead, when running a workflow for the first time you have to run everything anyways, so just run it. However, if one carefully records what was run (i.e. the data provenance Call Graph in redun) then you can consult the recording in future executions to decide what needs to be incrementally re-executed.</p></li>
<li><p>Build systems as described in “Build systems a la Carte” correspond to pull-style workflow engines (i.e. request a final target/file to be built). A general enough push-style workflow engine (i.e. give input arguments to a workflow) can implement pull-style and thus many build systems. Using the author’s terminology, redun can implement the suspending constructive trace-based build system. Using task option <code class="docutils literal notranslate"><span class="pre">check_valid="shallow"</span></code>, one can also implement the deep constructive trace rebuilding strategy. Because redun’s tasks can return additional tasks, they are most similar to Monadic tasks.</p></li>
</ul>
</li>
<li><p>Observability, distributed tracing: <a class="reference external" href="https://opentelemetry.lightstep.com/spans/">Spans</a></p>
<ul>
<li><p>Span trees play a similar role to redun’s Call Graph. Span attributes are equivalent to redun’s tag system.</p></li>
<li><p>redun’s Call Graphs should provide similar observability and debugging capabilities as span trees. One difference is that Call Graphs are intended to be retained long term in order to provide data provenance. In some ways, observability is like short-term data provenance.</p></li>
<li><p>redun’s Call Graph gives more attention to dataflow between Jobs than Spans typically do.</p></li>
</ul>
</li>
<li><p>Source control: <a class="reference external" href="https://git-scm.com/">git</a></p>
<ul>
<li><p>git provided several inspirations to redun. First, it is easy to get started with git, because users can simply run <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">init</span></code> to create a new local repo in the hidden directory <code class="docutils literal notranslate"><span class="pre">.git/</span></code>. Central configuration and coordination is not needed. As users change their code, they record each change using commands like <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> and <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span></code>. This can be seen as a form of provenance but for code, and the <a class="reference external" href="https://krishnabiradar.com/blogs/deconstructing-a-git-commit/">commit graph</a> is git’s data structure for storing this provenance information. The commit graph is a <a class="reference external" href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree</a> that uses hashes to give unique ids to each node in the graph and this enables efficient peer-to-peer syncing of commit graphs between repos using the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code> and <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code> commands. git provides many additional tools, such as <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">log</span></code> and <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">diff</span></code>, for inspecting commit graphs to help with the code development process.</p></li>
<li><p>To relate this to redun, redun also creates a local repo in <code class="docutils literal notranslate"><span class="pre">.redun/</span></code> on the first workflow run or with a <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">init</span></code> command. New data provenance is recorded each time users use the <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">run</span></code> command. These recordings are stored in the Call Graph data structure, which is also a Merkle tree. Users can sync Call Graphs efficiently using the <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">push</span></code> and <code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">pull</span></code> commands. redun also provides tools for using Call Graphs in the development process, such as exploring past executions (<code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">log</span></code>), figuring out the difference between two executions (<code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">diff</span></code>), and interactively exploring Call Graphs and data (<code class="docutils literal notranslate"><span class="pre">redun</span> <span class="pre">repl</span></code>).</p></li>
</ul>
</li>
<li><p>ML frameworks: <a class="reference external" href="https://www.tensorflow.org/">TensorFlow</a>, <a class="reference external" href="https://pytorch.org/">PyTorch</a></p>
<ul>
<li><p>ML frameworks can be thought of as workflow engines for tensors. They face similar issues for reifying computation so that they can automatically parallelize, distribute, and differentiate the compute described by a network. TensorFlow’s original Graph API required the network to be constructed upfront as a static directed acyclic graph (DAG), while TensorFlow and PyTorch’s eager execution APIs allow in-line compute graph definition during forward pass. In comparison, redun operates between these two extremes. In redun, task calls are always lazy, which produces an upfront graph of compute (an expression graph). However, tasks can return additional expressions, thus allowing the user to interleave static DAGs with arbitrary Python code. This allows redun to express very dynamic compute without the downsides of fully eager execution: constant access to a central scheduler, difficult to define checkpoints, data provenance gaps, etc.</p></li>
<li><p>Redun’s data provenance graph is also related to the tape-based automatic differentiation (often called autograd) in <a class="reference external" href="https://pytorch.org/tutorials/beginner/former_torchies/autograd_tutorial.html">Pytorch</a> and <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/GradientTape">TensorFlow</a>. Specifically, redun performs call graph recording, which tracks the lineage of task executions and emitted values, similar to the recoding of mathematical operators applied to the input during the forward pass of compute graphs in PyTorch/TensorFlow. The recorded redun call graph can then be recursively queried to examine the lineage of an output value, analogous to how ML frameworks recurse over the gradient tape to calculate derivatives of a compute graph’s execution.</p></li>
</ul>
</li>
<li><p>Database migration frameworks: <a class="reference external" href="https://alembic.sqlalchemy.org/">Alembic</a>, <a class="reference external" href="https://docs.djangoproject.com/en/3.2/topics/migrations/">Django migrations</a></p>
<ul>
<li><p>Migration frameworks are used to alter databases (both schemas and data) in a controlled manner. Frameworks, such as Alembic and Django migrations, encourage users to represent their migrations as atomic scripts arranged into a dependency DAG. The frameworks then provide command-line tools for upgrading and downgrading the database to a specific version node within the migration DAG. Such tools then execute the necessary migrations in topological sort order. In order to not apply the same migration twice, these frameworks often maintain a metadata table within the database. In a way, these frameworks are workflow engines with the same usual features of task dependency DAGs and caching logic.</p></li>
<li><p>One difference though, is that migration frameworks also encourage users to define an inverse for each “task”, that is each upgrade migration has a corresponding downgrade. When given a desired migration node version, these CLI tools may apply a combination of upgrade and downgrade migrations to move the database along a path in the migration DAG.</p></li>
<li><p>redun has an experimental feature called <code class="docutils literal notranslate"><span class="pre">Handle</span></code> for defining interactions with stateful services such as databases. redun must record similar metadata about the past states of the Handle and it is envisioned that inverse tasks, or rollbacks, could be defined and executed as needed.</p></li>
</ul>
</li>
<li><p>Causal hashing: <a class="reference external" href="https://arxiv.org/abs/1901.01908">Koji</a></p>
<ul>
<li><p>The Koji paper describes a way of using causal hashing to unify both file and web service use within a single workflow engine system. redun also aims for similar unification and provides a special Value type, Handle, for interacting with external services, such as databases and APIs. Handles solve the problem of giving a unique id to the state of an external system. When the external data source is a simple file, we can hash the file to give its state a unique id. However, when the external data source is a database, it is likely unreasonable to hash a whole database or web service. Instead, a causal hash can be defined as hashing the series of Call Nodes a Handle has passed through. This often gives an equally unique id for the state of an external service, while being more efficient.</p></li>
</ul>
</li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="tasks.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Tasks</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Home</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2020, Matt Rasmussen
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Design overview</a><ul>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#first-example">First example</a></li>
<li><a class="reference internal" href="#key-features">Key features</a><ul>
<li><a class="reference internal" href="#memoization-and-reactivity">Memoization and reactivity</a></li>
<li><a class="reference internal" href="#lazy-evaluation-and-parallelism">Lazy evaluation and parallelism</a></li>
<li><a class="reference internal" href="#tasks-as-pure-functions">Tasks as pure functions</a></li>
<li><a class="reference internal" href="#task-hashing">Task hashing</a></li>
<li><a class="reference internal" href="#task-naming">Task naming</a></li>
<li><a class="reference internal" href="#result-caching">Result caching</a></li>
<li><a class="reference internal" href="#file-reactivity">File reactivity</a></li>
<li><a class="reference internal" href="#shell-scripting">Shell scripting</a><ul>
<li><a class="reference internal" href="#script-tasks">Script tasks</a></li>
<li><a class="reference internal" href="#file-staging">File staging</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#working-with-values">Working with Values</a><ul>
<li><a class="reference internal" href="#nested-values">Nested values</a></li>
<li><a class="reference internal" href="#recursion">Recursion</a></li>
<li><a class="reference internal" href="#tasks-as-first-class-values">Tasks as first class values</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-provenance">Data provenance</a><ul>
<li><a class="reference internal" href="#call-graphs">Call graphs</a></li>
<li><a class="reference internal" href="#querying-call-graphs">Querying call graphs</a></li>
<li><a class="reference internal" href="#syncing-provenance-data">Syncing provenance data</a><ul>
<li><a class="reference internal" href="#repositories">Repositories</a></li>
<li><a class="reference internal" href="#running-redun-in-other-repositories">Running redun in other repositories</a></li>
<li><a class="reference internal" href="#synchronizing-repositories">Synchronizing repositories</a></li>
<li><a class="reference internal" href="#manual-exports">Manual exports</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-topics">Advanced topics</a><ul>
<li><a class="reference internal" href="#working-with-databases-and-apis">Working with databases and APIs</a></li>
<li><a class="reference internal" href="#handles-for-ephemeral-and-stateful-values">Handles for ephemeral and stateful values</a><ul>
<li><a class="reference internal" href="#state-tracking">State tracking</a></li>
<li><a class="reference internal" href="#more-advance-handle-uses">More advance Handle uses</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-wrapping">Task wrapping</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-notes">Implementation notes</a><ul>
<li><a class="reference internal" href="#evaluation-process">Evaluation process</a></li>
<li><a class="reference internal" href="#content-addressable-hashing-summary">Content addressable hashing summary</a></li>
<li><a class="reference internal" href="#connections-to-functional-programming">Connections to functional programming</a></li>
<li><a class="reference internal" href="#redun-a-language-within">redun: a language within</a></li>
</ul>
</li>
<li><a class="reference internal" href="#influences">Influences</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/furo.js"></script>
    </body>
</html>